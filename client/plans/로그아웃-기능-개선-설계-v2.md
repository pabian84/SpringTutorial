# UserController.logout 개선 설계

## 1. 현재 문제점

### 1.1 현재 UserController.logout 로직

```java
@PostMapping("/logout")
public ResponseEntity<?> logout(@RequestBody(required = false) Map<String, String> body, 
                                  HttpServletRequest request, HttpServletResponse response) {
    String userId = null;
    Long sessionId = null;
    String token = jwtTokenProvider.resolveToken(request);
    
    // body에서 userId 우선 사용 (토큰 만료 시)
    if (body != null && body.containsKey("userId")) {
        userId = body.get("userId");
    }
    
    // 토큰이 유효하면 sessionId 추출
    if (token != null && jwtTokenProvider.validateToken(token)) {
        sessionId = jwtTokenProvider.getSessionId(token);
        if (userId == null) {
            userId = jwtTokenProvider.getAuthentication(token).getName();
        }
    }
    
    if (userId != null) {
        String userAgent = request.getHeader("User-Agent");
        String ipAddress = request.getRemoteAddr();
        
        // ❌ 문제: sessionId가 없으면 전체 로그아웃 (의도치 않은 동작)
        if (sessionId != null) {
            userService.logout(userId, sessionId, userAgent, ipAddress);
            sessionService.forceDisconnectOne(userId, sessionId);
        } else {
            // ⚠️ 토큰이 없거나 만료된 경우에도 전체 로그아웃!
            userService.logoutAll(userId, userAgent, ipAddress);
            sessionService.forceDisconnectAll(userId);
        }
    }
    
    // 쿠키 삭제
    boolean isHttps = "https".equalsIgnoreCase(request.getScheme());
    ResponseCookie accessCookie = cookieUtil.deleteCookie("accessToken", isHttps);
    response.addHeader("Set-Cookie", accessCookie.toString());

    return ResponseEntity.ok().body("로그아웃 되었습니다.");
}
```

### 1.2 문제점 상세

| 시나리오 | 현재 동작 | 문제 |
|---------|----------|------|
| 정상 로그아웃 (토큰 유효) | 해당 세션만 삭제 ✅ | 정상 |
| 토큰 만료 후 로그아웃 시도 | **전체 세션 삭제** ❌ | 의도치 않은 동작 |
| 세션이 이미 삭제된 상태 | **전체 세션 삭제** ❌ | 의미 없음 + 경고 로그 |

## 2. 개선 설계

### 2.1 목표

1. **sessionId가 없으면 전체 로그아웃하지 않음**
   - 토큰이 없거나 만료된 경우 → 해당 userId로 세션 존재 여부만 확인
   - 존재하면 해당 세션만 삭제, 없으면 아무것도 하지 않음

2. **WebSocket은 반드시 끊음**
   - sessionId가 있으면 해당 세션만 끊음
   - sessionId가 없으면 userId로 모든 WebSocket 끊음

3. **세션 삭제 시 로그 추가**
   - SessionService.deleteSession에 로그 추가
   - UserService.logout에 로그 추가

### 2.2 개선된 UserController.logout

```java
@PostMapping("/logout")
public ResponseEntity<?> logout(@RequestBody(required = false) Map<String, String> body, 
                                  HttpServletRequest request, HttpServletResponse response) {
    String userId = null;
    Long sessionId = null;
    String token = jwtTokenProvider.resolveToken(request);
    
    // body에서 userId 우선 사용 (토큰 만료 시)
    if (body != null && body.containsKey("userId")) {
        userId = body.get("userId");
    }
    
    // 토큰이 유효하면 sessionId 추출
    if (token != null && jwtTokenProvider.validateToken(token)) {
        sessionId = jwtTokenProvider.getSessionId(token);
        if (userId == null) {
            userId = jwtTokenProvider.getAuthentication(token).getName();
        }
    }
    
    if (userId != null) {
        String userAgent = request.getHeader("User-Agent");
        String ipAddress = request.getRemoteAddr();
        
        // ✅ 개선: sessionId가 있을 때만 해당 세션 삭제
        if (sessionId != null) {
            // 1. DB에서 해당 세션 삭제
            userService.logout(userId, sessionId, userAgent, ipAddress);
            
            // 2. 해당 WebSocket만 강제 종료
            sessionService.forceDisconnectOne(userId, sessionId);
            
            log.info("로그아웃 처리: userId={}, sessionId={}", userId, sessionId);
        } else {
            // ⚠️ sessionId가 없는 경우 (토큰 없음/만료)
            
            // 1. 사용자의 세션이 있는지 확인
            List<Session> sessions = sessionMapper.findByUserId(userId);
            
            if (sessions != null && !sessions.isEmpty()) {
                // 세션이 있으면 전체 삭제
                userService.logoutAll(userId, userAgent, ipAddress);
                
                // 2. WebSocket은 반드시 끊음 (모든 세션)
                sessionService.forceDisconnectAll(userId);
                
                log.info("토큰 없음/만료로 전체 로그아웃: userId={}, sessionsCount={}", 
                         userId, sessions.size());
            } else {
                // 세션이 없으면 (이미 삭제됨) → WebSocket만 끊음
                sessionService.forceDisconnectAll(userId);
                
                log.info("세션 없음, WebSocket만 종료: userId={}", userId);
            }
        }
    } else {
        // userId도 없는 경우 → 쿠키만 삭제
        log.warn("로그아웃 요청: userId 없음, 쿠키만 삭제");
    }
    
    // 쿠키 삭제
    boolean isHttps = "https".equalsIgnoreCase(request.getScheme());
    ResponseCookie accessCookie = cookieUtil.deleteCookie("accessToken", isHttps);
    response.addHeader("Set-Cookie", accessCookie.toString());

    return ResponseEntity.ok().body("로그아웃 되었습니다.");
}
```

### 2.3 SessionService에 로그 추가

```java
/**
 * 특정 세션 삭제 (Kick / Logout)
 */
@Transactional
@CacheEvict(value = "online_users", allEntries = true)
public void deleteSession(Long targetSessionId, Long currentSessionId) {
    // 세션 조회
    Session targetSession = sessionMapper.findBySessionId(targetSessionId);
    if (targetSession == null) {
        throw new CustomException(ErrorCode.SESSION_NOT_FOUND);
    }
    
    String currentUserId = sessionMapper.findBySessionId(currentSessionId).getUserId();
    if (!targetSession.getUserId().equals(currentUserId)) {
        throw new CustomException(ErrorCode.NOT_MY_DEVICE);
    }
    
    // DB 삭제
    sessionMapper.deleteBySessionId(targetSessionId);
    
    // ✅ 로그 추가
    log.info("세션 삭제됨: userId={}, sessionId={}", 
             targetSession.getUserId(), targetSessionId);
    
    // 로그 기록
    accessLogService.saveLog(currentUserId, currentSessionId, 
                             SecurityConstants.TYPE_KICK, null, null, null, null);
}

/**
 * 모든 기기 로그아웃
 */
@Transactional
@CacheEvict(value = "online_users", allEntries = true)
public void deleteAllSessions(String userId, Long currentSessionId) {
    sessionMapper.deleteByUserId(userId);
    
    // ✅ 로그 추가
    log.info("전체 세션 삭제됨: userId={}", userId);
    
    // 로그 기록
    accessLogService.saveLog(userId, currentSessionId, 
                             SecurityConstants.TYPE_KICK, null, null, null, "ALL_DEVICES");
}
```

### 2.4 UserService에 로그 추가

```java
/**
 * 로그아웃 처리 (세션 삭제)
 */
public void logout(String userId, Long sessionId, String userAgent, String ipAddress) {
    // DB에서 세션 삭제
    sessionMapper.deleteBySessionId(sessionId);
    
    // ✅ 로그 추가 (이 부분이 빠져 있었음!)
    log.info("로그아웃: userId={}, sessionId={}, device={}, ip={}", 
             userId, sessionId, userAgent, ipAddress);
    
    // 로그 기록
    accessLogService.saveLog(userId, sessionId, 
                            SecurityConstants.TYPE_LOGOUT, null, null, ipAddress, userAgent);
}
```

## 3. 플로우 다이어그램

### 3.1 개선된 로그아웃 플로우

```mermaid
flowchart TD
    A[POST /api/user/logout] --> B{토큰 유효?}
    B -->|유효| C[sessionId 추출<br/>userId 추출]
    B -->|만료/없음| D[body에서 userId 추출]
    
    C --> E{sessionId != null?}
    D --> F[userId != null?]
    
    E -->|Yes| G[userService.logout<br/>sessionService.forceDisconnectOne]
    E -->|No| H[DB에서 userId의<br/>세션 존재 확인]
    
    F -->|Yes| I[세션 존재?]
    F -->|No| J[쿠키만 삭제<br/>로그: userId 없음]
    
    H -->|존재| K[userService.logoutAll<br/>sessionService.forceDisconnectAll]
    H -->|없음| L[sessionService.forceDisconnectAll<br/>로그: 세션 없음]
    
    G --> M[쿠키 삭제]
    K --> M
    L --> M
    J --> M
    
    M --> N[200 OK<br/>"로그아웃 되었습니다."]
    
    style G fill:#90EE90
    style K fill:#FFE4B5
    style L fill:#FFE4B5
    style J fill:#FFB6C1
```

### 3.2 시나리오별 동작

| 시나리오 | sessionId | 세션 존재 | 동작 | 로그 |
|---------|-----------|---------|------|------|
| 정상 로그아웃 | ✅ | ✅ | 해당 세션만 삭제 | `로그아웃: userId=xxx, sessionId=993` |
| 토큰 만료, 세션 존재 | ❌ | ✅ | 전체 세션 삭제 | `토큰 없음/만료로 전체 로그아웃` |
| 토큰 만료, 세션 없음 | ❌ | ❌ | WebSocket만 끊음 | `세션 없음, WebSocket만 종료` |
| userId 없음 | ❌ | ❌ | 쿠키만 삭제 | `로그아웃 요청: userId 없음` |

## 4. 필요한 변경 사항 요약

### 4.1 UserController.java 변경

1. sessionId가 null일 때 전체 로그아웃하지 않음
2. userId로 세션 존재 여부 확인 후 적절히 처리
3. 모든 경우에 WebSocket 종료

### 4.2 SessionService.java 변경

1. `deleteSession()`에 로그 추가
2. `deleteAllSessions()`에 로그 추가

### 4.3 UserService.java 변경

1. `logout()`에 로그 추가

### 4.4 추가 필요한 경우

SessionMapper에 `findByUserId` 메서드가 필요할 수 있음:
```java
// SessionMapper.java
List<Session> findByUserId(String userId);
```

## 5. 예상 효과

| 개선 전 | 개선 후 |
|--------|--------|
| sessionId 없으면 전체 세션 삭제 | sessionId 없으면 해당 세션만 삭제 (또는 이미 삭제됨 처리) |
| 세션 삭제 로그가 불명확 | 명확한 로그로 디버깅 용이 |
| WebSocket 종료 로직 불분명 | 모든 경우에 WebSocket 종료 보장 |
