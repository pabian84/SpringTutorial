# 프로젝트 전체 아키텍처 분석 보고서 v2

## 분석 개요

본 문서는 SpringTutorial 프로젝트의 프론트엔드(React + Vite)와 백엔드(Spring Boot) 전체를 분석한 결과입니다.

### 분석 대상 파일 (총 36개)

**백엔드 (20개)**
- Controller: UserController, SessionController, AuthController
- Service: UserService, SessionService, AccessLogService
- Mapper: UserMapper, SessionMapper
- Entity: User, Session, AccessLog
- Security: JwtTokenProvider, JwtAuthenticationFilter, SecurityConfig
- Config: JwtProperties, JwtHandshakeInterceptor, WebSocketConfig, CorsProperties
- Handler: WebSocketHandler
- Util: CookieUtil
- Constants: SecurityConstants, JwtConstants, ErrorCode
- Resources: application.yml

**프론트엔드 (16개)**
- Pages: Dashboard, Login, DeviceManagement
- Contexts: AuthProvider, AuthContext, WebSocketProvider, WebSocketContext
- Hooks: useDashboardData
- API: userApi, sessionApi
- Utils: axiosConfig, authUtility
- Constants: auth, authRef
- Types: dtos
- App: App.tsx

---

## 1. 시스템 아키텍처 다이어그램

> **참고**: 다이어그램은 Mermaid 문법으로 작성되었습니다. GitHub, VS Code (Mermaid 플러그인 설치 시), 또는 [Mermaid Live Editor](https://mermaid.live)에서 정상적으로 확인할 수 있습니다.

### 1.1 전체 시스템 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND (React + Vite)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  App.tsx                                                                     │
│    └── WebSocketProvider                                                     │
│          └── AuthProvider                                                    │
│                └── Routes                                                    │
│                      ├── Login (Public)                                      │
│                      ├── Dashboard (Protected)                               │
│                      ├── DeviceManagement (Protected)                        │
│                      └── ...                                                 │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │  AuthProvider   │  │ WebSocketProvider│  │   API Layer     │             │
│  │  - login()      │  │ - connectSocket()│  │ - userApi       │             │
│  │  - logout()     │  │ - forceReconnect │  │ - sessionApi    │             │
│  │  - checkAuth()  │  │ - forceDisconnect│  │ - widgetApi     │             │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘             │
│           │                    │                     │                       │
│           └────────────────────┴─────────────────────┘                       │
│                                │                                             │
│                    ┌───────────┴───────────┐                                │
│                    │   Axios Interceptors  │                                │
│                    │   - 401/403 처리      │                                │
│                    │   - 인증 재확인       │                                │
│                    └───────────┬───────────┘                                │
└────────────────────────────────┼────────────────────────────────────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │   HttpOnly Cookie       │
                    │   (accessToken)         │
                    └────────────┬────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            BACKEND (Spring Boot)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Security Filter Chain                           │   │
│  │  ┌─────────────────┐                                                 │   │
│  │  │ JwtAuthFilter   │ → 토큰 검증 → 세션 존재 확인                    │   │
│  │  └─────────────────┘                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ UserController  │  │SessionController │  │ AuthController  │             │
│  │ - POST /login   │  │ - GET /sessions  │  │ - GET /check    │             │
│  │ - POST /logout  │  │ - POST /revoke   │  │                 │             │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘             │
│           │                    │                     │                       │
│           └────────────────────┴─────────────────────┘                       │
│                                │                                             │
│  ┌─────────────────────────────┴───────────────────────────────────────┐   │
│  │                         Service Layer                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │
│  │  │ UserService     │  │ SessionService  │  │ AccessLogService│     │   │
│  │  │ - login()       │  │ - deleteSession │  │ - saveLog()     │     │   │
│  │  │ - logout()      │  │ - forceDisconnect│  │                 │     │   │
│  │  └────────┬────────┘  └────────┬────────┘  └─────────────────┘     │   │
│  └───────────┼────────────────────┼────────────────────────────────────┘   │
│              │                    │                                          │
│  ┌───────────┴────────────────────┴────────────────────────────────────┐   │
│  │                          Data Layer                                  │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │
│  │  │ UserMapper      │  │ SessionMapper   │  │ Spring Cache    │     │   │
│  │  │ SessionMapper   │  │ - CRUD          │  │ - online_users  │     │   │
│  │  └────────┬────────┘  └────────┬────────┘  └─────────────────┘     │   │
│  └───────────┼────────────────────┼────────────────────────────────────┘   │
│              │                    │                                          │
│              ▼                    ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │                        H2 Database                                 │     │
│  │  - users, user_sessions, access_log, memos, chat_history          │     │
│  └───────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────┐     │
│  │                      WebSocket Handler                             │     │
│  │  ┌─────────────────┐  ┌─────────────────────────────────────┐     │     │
│  │  │ JwtHandshake    │  │ WebSocketHandler                    │     │     │
│  │  │ Interceptor     │  │ - afterConnectionEstablished        │     │     │
│  │  │ - 토큰 검증     │  │ - handleTextMessage                 │     │     │
│  │  │ - userId 추출   │  │ - afterConnectionClosed             │     │     │
│  │  └─────────────────┘  └─────────────────────────────────────┘     │     │
│  └───────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 인증 흐름 상세

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              인증 흐름                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  [로그인]                                                                    │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │  User   │───▶│  Login  │───▶│ /login  │───▶│ UserService│──▶│ Session │  │
│  │         │    │  Page   │    │  API    │    │           │    │  DB     │  │
│  └─────────┘    └─────────┘    └────┬────┘    └───────────┘    └─────────┘  │
│                                      │                                       │
│                                      ▼                                       │
│                               ┌─────────────┐                               │
│                               │ Set-Cookie  │                               │
│                               │ accessToken │                               │
│                               │ (httpOnly)  │                               │
│                               └─────────────┘                               │
│                                                                              │
│  [API 요청]                                                                  │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │  API    │───▶│ Axios   │───▶│ Cookie  │───▶│ JwtAuth │───▶│ Session │  │
│  │ Call    │    │Config   │    │ Auto    │    │ Filter  │    │  DB     │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                                              │
│  [토큰 만료 시]                                                              │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐                  │
│  │  401    │───▶│ Axios   │───▶│ checkAuth│───▶│ 결과에  │                  │
│  │ Error   │    │Intercept│    │  Status │    │따라 처리│                  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘                  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 주요 시나리오 도식화

### 2.1 로그인 시나리오

```
User                Login.tsx           AuthProvider         API              Backend
  │                    │                    │                 │                  │
  │  ID/PW 입력        │                    │                 │                  │
  │───────────────────▶│                    │                 │                  │
  │                    │  login() 호출      │                 │                  │
  │                    │───────────────────▶│                 │                  │
  │                    │                    │  POST /login    │                  │
  │                    │                    │────────────────▶│                  │
  │                    │                    │                 │  사용자 검증     │
  │                    │                    │                 │─────────────────▶│
  │                    │                    │                 │                  │
  │                    │                    │                 │  Session 저장    │
  │                    │                    │                 │◀─────────────────│
  │                    │                    │                 │                  │
  │                    │                    │                 │  JWT 생성        │
  │                    │                    │                 │◀─────────────────│
  │                    │                    │                 │                  │
  │                    │                    │  Set-Cookie     │                  │
  │                    │                    │◀────────────────│                  │
  │                    │                    │  (accessToken)  │                  │
  │                    │                    │                 │                  │
  │                    │  user 정보 반환    │                 │                  │
  │                    │◀───────────────────│                 │                  │
  │                    │                    │                 │                  │
  │                    │  navigate(/dashboard)               │                  │
  │                    │                    │                 │                  │
  │  대시보드로 이동   │                    │                 │                  │
  │◀───────────────────│                    │                 │                  │
```

### 2.2 로그아웃 시나리오

```
User            Dashboard        AuthProvider      WebSocketProvider     API        Backend
  │                 │                │                   │               │            │
  │  로그아웃 클릭  │                │                   │               │            │
  │────────────────▶│                │                   │               │            │
  │                 │  logout()      │                   │               │            │
  │                 │───────────────▶│                   │               │            │
  │                 │                │  forceDisconnect  │               │            │
  │                 │                │──────────────────▶│               │            │
  │                 │                │                   │  WS Close     │            │
  │                 │                │                   │──────────────▶│            │
  │                 │                │                   │               │            │
  │                 │                │  POST /logout     │               │            │
  │                 │                │──────────────────────────────────▶│            │
  │                 │                │                   │               │  세션 삭제 │
  │                 │                │                   │               │───────────▶│
  │                 │                │                   │               │            │
  │                 │                │  Delete Cookie    │               │◀───────────│
  │                 │                │◀──────────────────────────────────│            │
  │                 │                │                   │               │            │
  │                 │                │  상태 초기화      │               │            │
  │                 │                │  localStorage 정리│               │            │
  │                 │                │                   │               │            │
  │  로그인 페이지로│                │                   │               │            │
  │◀────────────────────────────────│                   │               │            │
```

### 2.3 토큰 만료 시나리오

```
Frontend         AxiosInterceptor    authUtility        AuthController      Backend
  │                   │                  │                   │               │
  │  API 요청         │                  │                   │               │
  │──────────────────▶│                  │                   │               │
  │                   │  요청 전송       │                   │               │
  │                   │──────────────────────────────────────────────────────▶│
  │                   │                  │                   │               │
  │                   │  401 Error       │                   │               │
  │                   │◀─────────────────────────────────────────────────────│
  │                   │                  │                   │               │
  │                   │  isProcessingError 체크              │               │
  │                   │  (중복 방지)     │                   │               │
  │                   │                  │                   │               │
  │                   │  checkAuthStatus │                   │               │
  │                   │─────────────────▶│                   │               │
  │                   │                  │  GET /auth/check  │               │
  │                   │                  │──────────────────▶│               │
  │                   │                  │                   │  토큰 검증    │
  │                   │                  │                   │──────────────▶│
  │                   │                  │                   │               │
  │                   │                  │  [토큰 유효]      │               │
  │                   │                  │  authenticated:true              │
  │                   │                  │◀──────────────────│               │
  │                   │  인증 성공       │                   │               │
  │                   │◀─────────────────│                   │               │
  │                   │  요청 재시도     │                   │               │
  │                   │──────────────────────────────────────────────────────▶│
  │  정상 응답        │                  │                   │               │
  │◀──────────────────│                  │                   │               │
  │                   │                  │                   │               │
  │                   │                  │  [토큰 만료]      │               │
  │                   │                  │  401              │               │
  │                   │                  │◀──────────────────│               │
  │                   │  인증 실패       │                   │               │
  │                   │◀─────────────────│                   │               │
  │                   │  onAuthFailed    │                   │               │
  │                   │─────────────────▶│                   │               │
  │  로그인 페이지로  │                  │                   │               │
  │◀──────────────────│                  │                   │               │
```

### 2.4 기기 강퇴(Kick) 시나리오

```
User          DeviceManagement      sessionApi       SessionController    SessionService     WebSocket
  │                 │                   │                  │                   │               │
  │  기기 강퇴 클릭│                   │                  │                   │               │
  │────────────────▶│                   │                  │                   │               │
  │                 │  revokeSession    │                  │                   │               │
  │                 │──────────────────▶│                  │                   │               │
  │                 │                   │  POST /revoke    │                   │               │
  │                 │                   │─────────────────▶│                   │               │
  │                 │                   │                  │  deleteSession    │               │
  │                 │                   │                  │──────────────────▶│               │
  │                 │                   │                  │                   │  DB 삭제     │
  │                 │                   │                  │                   │──────────────▶│
  │                 │                   │                  │                   │               │
  │                 │                   │                  │  forceDisconnect  │               │
  │                 │                   │                  │◀──────────────────│               │
  │                 │                   │                  │                   │               │
  │                 │                   │                  │                   │  WS Close    │
  │                 │                   │                  │                   │  (4001)      │
  │                 │                   │                  │                   │──────────────▶│
  │                 │                   │                  │                   │               │
  │                 │                   │  완료            │                   │               │
  │                 │                   │◀─────────────────│                   │               │
  │                 │  목록 갱신        │                  │                   │               │
  │                 │◀──────────────────│                  │                   │               │
  │  토스트 표시    │                   │                  │                   │               │
  │◀────────────────│                   │                  │                   │               │
```

### 2.5 다른 기기에서 로그인 (세션 초과) 시나리오

```
New Device                      Backend                      Old Device
    │                              │                              │
    │  로그인 요청                 │                              │
    │─────────────────────────────▶│                              │
    │                              │  세션 개수 확인 (5개 제한)   │
    │                              │  ────────────────────────    │
    │                              │                              │
    │                              │  [5개 초과 시]               │
    │                              │  가장 오래된 세션 삭제       │
    │                              │  ────────────────────────    │
    │                              │                              │
    │                              │  forceDisconnectWebSocket    │
    │                              │─────────────────────────────▶│
    │                              │                              │  WebSocket Close (4001)
    │                              │                              │  ────────────────────
    │                              │                              │
    │                              │                              │  재연결 시도
    │                              │                              │  ────────────────────
    │                              │                              │
    │                              │◀─────────────────────────────│
    │                              │  401 Unauthorized            │
    │                              │  (세션 없음)                 │
    │                              │                              │
    │                              │                              │  로그인 페이지로
    │                              │                              │  ────────────────────
    │                              │                              │
    │  로그인 성공                 │                              │
    │◀─────────────────────────────│                              │
```

---

## 3. 토큰 만료/Kick 시나리오 상세 분석

### 3.1 페이지 이동 중 토큰 만료

```
┌─────────────────────────────────────────────────────────────────┐
│                    페이지 이동 중 토큰 만료                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [정상 상태]                                                    │
│  Page A ────────────────────────────────────────────────────── │
│     │                                                           │
│     │  토큰 만료 발생                                           │
│     ▼                                                           │
│  [만료 상태]                                                    │
│  Page A ──── API 호출 ────▶ 401 Error                          │
│     │                           │                               │
│     │                           ▼                               │
│     │                    Axios Interceptor                      │
│     │                           │                               │
│     │                    checkAuthStatus()                      │
│     │                           │                               │
│     │                    ┌──────┴──────┐                        │
│     │                    │             │                        │
│     │               [인증 성공]   [인증 실패]                   │
│     │                    │             │                        │
│     │              요청 재시도    로그인 페이지                 │
│     │                    │             │                        │
│     │                    ▼             ▼                        │
│  Page B ◀───────────────┘         Login Page                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 WebSocket 연결 중 토큰 만료

```
┌─────────────────────────────────────────────────────────────────┐
│                  WebSocket 연결 중 토큰 만료                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [WebSocket 연결됨]                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  WebSocketProvider                                       │   │
│  │  - isConnected: true                                     │   │
│  │  - socketRef: WebSocket                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│     │                                                           │
│     │  토큰 만료 (또는 서버에서 세션 삭제)                      │
│     ▼                                                           │
│  [서버에서 연결 종료]                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Close Code: 4001 (Force Logout)                         │   │
│  │  또는 1000 (Normal Close)                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│     │                                                           │
│     ▼                                                           │
│  [onclose 이벤트 발생]                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  WebSocketProvider.onclose                               │   │
│  │  1. isAuthenticated() 확인                               │   │
│  │  2. 인증 실패 시 재연결 중단                              │   │
│  │  3. 인증 성공 시 재연결 시도                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│     │                                                           │
│     ├─────────────────────────────────────────┐                │
│     │                                         │                │
│  [인증 실패]                              [인증 성공]           │
│     │                                         │                │
│     ▼                                         ▼                │
│  재연결 중단                            재연결 시도             │
│  로그인 페이지                          (3초 후)                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 사용자 질문 답변

### Q1. 분석 파일 개수에 대하여

**답변**: 총 36개 파일을 분석했습니다.
- 백엔드: 20개 (Controller 3개, Service 3개, Mapper 2개, Entity 3개, Security 3개, Config 4개, Handler 1개, Util 1개, Constants 3개)
- 프론트엔드: 16개 (Pages 3개, Contexts 4개, Hooks 1개, API 2개, Utils 2개, Constants 2개, Types 1개, App 1개)

### Q2. 다이어그램이 안 보이는 문제

**답변**: Mermaid 문법으로 작성된 다이어그램은 다음 환경에서 확인 가능합니다:
1. **GitHub**: .md 파일을 GitHub에 올리면 자동 렌더링
2. **VS Code**: "Markdown Preview Mermaid Support" 확장 설치
3. **Mermaid Live Editor**: https://mermaid.live 에서 코드 붙여넣기
4. **IntelliJ IDEA**: Mermaid 플러그인 설치

이번 버전에서는 ASCII 아트 스타일의 다이어그램도 함께 제공합니다.

### Q3. lastAccessedAt 업데이트와 maxAge -1 방식의 호환성

**답변**: **완전히 호환됩니다.** 두 가지는 독립적인 개념입니다:

| 개념 | 위치 | 역할 |
|------|------|------|
| `maxAge: -1` | 브라우저 쿠키 | 브라우저 닫으면 쿠키 삭제 (세션 쿠키) |
| `lastAccessedAt` | DB 세션 테이블 | 마지막 활동 시간 기록 |

**현재 구현 방식**:
```java
// UserController.java - 로그인
if (req.isRememberMe()) {
    maxAge = 7 * 24 * 60 * 60; // 7일
} else {
    maxAge = -1; // 세션 쿠키 (브라우저 닫으면 삭제)
}
```

```java
// SessionMapper.java - 세션 저장
INSERT INTO user_sessions (..., last_accessed_at, ...)
VALUES (..., NOW(), ...)
```

**작동 방식**:
1. `maxAge: -1` → 브라우저 탭/창 닫으면 쿠키 삭제
2. `keepLogin: true` → `maxAge: 7일` → 브라우저 닫아도 쿠키 유지
3. `lastAccessedAt` → DB에 저장, 세션 정리용으로 사용

**lastAccessedAt 업데이트 방식을 추가해도**:
- 쿠키의 `maxAge` 설정에는 영향 없음
- DB 세션 테이블의 `last_accessed_at` 컬럼만 업데이트
- 세션 만료 정책 (예: 30일 이상 비활성 세션 삭제)에 활용 가능

### Q4. 인증 캐시 TTL이란?

**답변**: TTL(Time To Live)은 **캐시된 데이터의 유효 시간**입니다.

**현재 문제점**:
```typescript
// authUtility.ts
let authCheckResult: { authenticated: boolean; user?: UserInfo } | null = null;
// 한 번 인증 성공하면 결과가 계속 캐시됨
```

**문제 시나리오**:
1. 사용자 로그인 → `authCheckResult = { authenticated: true }`
2. 토큰 만료 (15초 후)
3. 다른 API 호출에서 401 발생
4. `checkAuthStatus()` 호출 → 캐시된 `{ authenticated: true }` 반환
5. 실제로는 토큰이 만료되었지만 캐시 때문에 인증된 것으로 잘못 판단

**TTL 추가 방안**:
```typescript
interface CachedAuthResult {
  result: { authenticated: boolean; user?: UserInfo };
  timestamp: number;
}

const CACHE_TTL = 5000; // 5초

export const checkAuthStatus = async () => {
  // 캐시 확인 + TTL 체크
  if (authCheckResult && Date.now() - authCheckResult.timestamp < CACHE_TTL) {
    return authCheckResult.result;
  }
  // 캐시 만료 또는 없음 → API 호출
  // ...
};
```

### Q5. 로그아웃 시 전체 삭제에 대하여

**답변**: 피드백 감사합니다. **여러 기기 동시 접속 지원 설계를 확인했습니다.**

**현재 로그아웃 로직 분석**:
```java
// UserController.java
if (sessionId != null) {
    userService.logout(userId, sessionId, userAgent, ipAddress);  // 특정 세션만 삭제
} else {
    // sessionId가 없는 경우 전체 삭제하지 않음
    log.warn("로그아웃 요청: sessionId 없음, userId={}", userId);
}
```

**이 설계가 맞습니다.** 이유:
1. 여러 기기에서 동시 접속 가능
2. 로그아웃은 현재 기기만 로그아웃
3. 전체 로그아웃은 별도 API (`DELETE /api/sessions/all`)

**개선이 필요한 부분**:
- 토큰 만료 상태에서 로그아웃 요청 시 `sessionId`를 알 수 없음
- 이 경우 현재 기기의 세션을 찾을 방법이 없음
- **제안**: 만료된 토큰에서도 `sessionId`를 추출하여 로그아웃 처리

```java
// 개선안
if (token != null) {
    // 만료된 토큰에서도 sessionId 추출
    sessionId = jwtTokenProvider.getSessionIdFromExpiredToken(token);
}
```

### Q6. 이벤트 기반 아키텍처와 레이스 컨디션

**답변**: **이벤트 기반 아키텍처는 레이스 컨디션 해결에 도움이 됩니다.**

**현재 발생 가능한 레이스 컨디션 분석**:

1. **로그인/로그아웃 이벤트 경쟁**
```typescript
// 현재 구현
window.addEventListener('authLogin', handleLogin);
window.addEventListener('authLogout', handleLogout);
```
- 문제: 로그인 직후 로그아웃 이벤트가 먼저 처리될 수 있음

2. **인증 확인 중복 호출**
```typescript
// axiosConfig.ts
if (isProcessingError) return false;  // 중복 방지 플래그
```
- 문제: 플래그 체크와 설정 사이에 경쟁 가능

3. **WebSocket 재연결 경쟁**
```typescript
// WebSocketProvider.tsx
if (isConnectingRef.current) return;  // 연결 중이면 스킵
```
- 문제: 여러 곳에서 동시에 `forceReconnect()` 호출 시

**이벤트 기반 아키텍처 개선 방안**:

```
┌─────────────────────────────────────────────────────────────────┐
│                    이벤트 기반 아키텍처                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Event Bus (중앙 이벤트 관리)           │   │
│  │                                                         │   │
│  │  Events:                                                │   │
│  │  - AUTH_LOGIN_SUCCESS                                   │   │
│  │  - AUTH_LOGOUT                                          │   │
│  │  - AUTH_TOKEN_EXPIRED                                   │   │
│  │  - WS_CONNECTED                                         │   │
│  │  - WS_DISCONNECTED                                      │   │
│  │  - WS_RECONNECT_REQUESTED                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│     │           │           │           │                       │
│     ▼           ▼           ▼           ▼                       │
│  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐                   │
│  │Auth   │  │WS     │  │API    │  │UI     │                   │
│  │Provider│  │Provider│  │Layer  │  │Components│                │
│  └───────┘  └───────┘  └───────┘  └───────┘                   │
│                                                                 │
│  장점:                                                          │
│  1. 단일 이벤트 소스 - 순서 보장                               │
│  2. 이벤트 큐잉 - 동시 요청 처리                               │
│  3. 상태 동기화 - 모든 컴포넌트가 동일한 상태 참조             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**구현 예시**:
```typescript
// eventBus.ts
class EventBus {
  private queue: Array<() => Promise<void>> = [];
  private processing = false;

  async emit(event: string, data?: any) {
    this.queue.push(async () => {
      // 이벤트 처리
    });
    if (!this.processing) {
      this.processing = true;
      while (this.queue.length > 0) {
        const task = this.queue.shift();
        await task?.();
      }
      this.processing = false;
    }
  }
}
```

---

## 5. 시나리오별 문제점 분석

### 5.1 로그인 시나리오

| 문제점 | 심각도 | 설명 | 위치 |
|--------|--------|------|------|
| 세션 제한 경고 없음 | 중 | 5개 세션 초과 시 가장 오래된 세션이 삭제되지만 사용자에게 알림 없음 | UserService.java:57-62 |
| WebSocket 연결 타이밍 | 낮음 | 로그인 후 WebSocket 연결이 setTimeout으로 처리 | AuthProvider.tsx:66-71 |

### 5.2 로그아웃 시나리오

| 문제점 | 심각도 | 설명 | 위치 |
|--------|--------|------|------|
| 만료된 토큰으로 로그아웃 시 세션 삭제 안됨 | 중 | sessionId를 알 수 없어 DB 세션이 삭제되지 않음 | UserController.java:107-111 |
| WebSocket 종료 순서 | 낮음 | Frontend에서 먼저 WebSocket을 닫지만 이미 닫혀있을 수 있음 | AuthProvider.tsx:88 |

### 5.3 토큰 만료 시나리오

| 문제점 | 심각도 | 설명 | 위치 |
|--------|--------|------|------|
| Refresh Token 미사용 | 설계상 결정 | AccessToken만 사용하여 만료 시 재로그인 필수 | sessionApi.ts:11-12 |
| 인증 확인 캐싱에 TTL 없음 | 중 | 캐시된 결과가 만료 후에도 사용될 수 있음 | authUtility.ts:11-12 |
| Race Condition 방지 있음 | 양호 | isProcessingError 플래그로 중복 처리 방지 | axiosConfig.ts:57-59 |

### 5.4 기기 강퇴(Kick) 시나리오

| 문제점 | 심각도 | 설명 | 위치 |
|--------|--------|------|------|
| WebSocket sessionId 미전달 | 높음 | JwtHandshakeInterceptor에서 sessionId를 null로 설정 | JwtHandshakeInterceptor.java:62 |
| 피드백 메시지 부족 | 중 | 강퇴당한 기기에서 명확한 피드백 없음 | useDashboardData.ts:171-177 |

### 5.5 WebSocket 관련

| 문제점 | 심각도 | 설명 | 위치 |
|--------|--------|------|------|
| 만료된 토큰으로 연결 허용 | 높음 | 만료된 토큰에서도 userId 추출하여 연결 허용 | JwtHandshakeInterceptor.java:42 |
| sessionId 미전달 | 높음 | WebSocket에서 세션 식별 불가 | JwtHandshakeInterceptor.java:62 |
| 재연결 무한 루프 방지 있음 | 양호 | isAuthenticated 체크로 방지 | WebSocketProvider.tsx:88-93 |

---

## 6. 개선사항 도출

### 6.1 높은 우선순위 (즉시 개선 권장)

#### 6.1.1 WebSocket sessionId 전달 수정

**현재 문제**:
```java
// JwtHandshakeInterceptor.java:62
attributes.put("sessionId", (Long) null);  // 항상 null
```

**개선 방안**:
```java
// 토큰에서 sessionId 추출하여 전달
Long sessionId = null;
if (token != null) {
    sessionId = jwtTokenProvider.getSessionIdFromExpiredToken(token);
}
attributes.put("sessionId", sessionId);
```

**영향**: 기기 강퇴 기능 정상 동작

#### 6.1.2 WebSocket 인증 강화

**현재 문제**:
```java
// JwtHandshakeInterceptor.java:42
userId = jwtTokenProvider.getUserIdFromExpiredToken(token);  // 만료된 토큰도 허용
```

**개선 방안**:
```java
// 옵션 1: 유효한 토큰만 허용
if (jwtTokenProvider.validateToken(token)) {
    userId = jwtTokenProvider.getUserIdFromToken(token);
} else {
    response.setStatusCode(HttpStatus.UNAUTHORIZED);
    return false;
}

// 옵션 2: 세션 존재 확인 추가
Long sessionId = jwtTokenProvider.getSessionIdFromExpiredToken(token);
if (sessionId != null && sessionMapper.findBySessionId(sessionId) == null) {
    response.setStatusCode(HttpStatus.UNAUTHORIZED);
    return false;
}
```

**영향**: 보안 강화

#### 6.1.3 인증 확인 캐싱 TTL 추가

**현재 문제**:
```typescript
// authUtility.ts
let authCheckResult: { authenticated: boolean; user?: UserInfo } | null = null;
```

**개선 방안**:
```typescript
interface CachedAuthResult {
  result: { authenticated: boolean; user?: UserInfo };
  timestamp: number;
}

let authCheckResult: CachedAuthResult | null = null;
const CACHE_TTL = 5000; // 5초

export const checkAuthStatus = async () => {
  if (authCheckResult && Date.now() - authCheckResult.timestamp < CACHE_TTL) {
    return authCheckResult.result;
  }
  // API 호출...
};
```

**영향**: 토큰 만료 후 즉시 감지

### 6.2 중간 우선순위 (단기 개선 권장)

#### 6.2.1 만료된 토큰으로 로그아웃 개선

**현재 문제**:
```java
// UserController.java:107-111
if (sessionId != null) {
    userService.logout(userId, sessionId, userAgent, ipAddress);
} else {
    log.warn("로그아웃 요청: sessionId 없음, userId={}", userId);
    // 세션 삭제 안됨
}
```

**개선 방안**:
```java
// 만료된 토큰에서도 sessionId 추출
if (token != null && sessionId == null) {
    sessionId = jwtTokenProvider.getSessionIdFromExpiredToken(token);
}

if (sessionId != null) {
    userService.logout(userId, sessionId, userAgent, ipAddress);
    sessionService.forceDisconnectWebSocket(userId, sessionId);
}
```

**영향**: 만료된 토큰으로도 정상 로그아웃 처리

#### 6.2.2 세션 알림 시스템

**개선 방안**:
```java
// 새 기기 로그인 시 기존 기기에 알림
// SessionService.java
public void notifyNewLogin(String userId, String deviceType) {
    Map<String, Object> data = new HashMap<>();
    data.put("type", "NEW_LOGIN_ALERT");
    data.put("deviceType", deviceType);
    data.put("timestamp", System.currentTimeMillis());
    // WebSocket으로 브로드캐스트
    webSocketHandler.broadcastToUser(userId, data);
}
```

**영향**: UX 개선

### 6.3 낮은 우선순위 (장기 개선 권장)

#### 6.3.1 이벤트 기반 아키텍처 도입

**현재 문제**: 레이스 컨디션 발생 가능

**개선 방안**:
```typescript
// 중앙 이벤트 버스 도입
class AuthEventBus {
  private static instance: AuthEventBus;
  private eventQueue: AuthEvent[] = [];
  private processing = false;

  static getInstance() {
    if (!AuthEventBus.instance) {
      AuthEventBus.instance = new AuthEventBus();
    }
    return AuthEventBus.instance;
  }

  async emit(event: AuthEvent) {
    this.eventQueue.push(event);
    await this.processQueue();
  }

  private async processQueue() {
    if (this.processing) return;
    this.processing = true;
    
    while (this.eventQueue.length > 0) {
      const event = this.eventQueue.shift();
      await this.handleEvent(event);
    }
    
    this.processing = false;
  }
}
```

**영향**: 레이스 컨디션 해결, 코드 유지보수성 향상

#### 6.3.2 lastAccessedAt 업데이트 구현

**개선 방안**:
```java
// SessionMapper.java에 추가
@Update("UPDATE user_sessions SET last_accessed_at = NOW() WHERE id = #{sessionId}")
void updateLastAccessed(@Param("sessionId") Long sessionId);

// JwtAuthenticationFilter.java에서 호출
if (sessionId != null && sessionMapper.findBySessionId(sessionId) != null) {
    sessionMapper.updateLastAccessed(sessionId);  // 활동 시간 업데이트
}
```

**영향**: 세션 활동 추적, 비활성 세션 정리 가능

---

## 7. 기타 발견 사항

### 7.1 코드 품질

| 항목 | 상태 | 비고 |
|------|------|------|
| TypeScript 타입 정의 | 양호 | DTO 타입 잘 정의됨 (dtos.ts) |
| 에러 코드 체계 | 양호 | ErrorCode enum으로 관리 |
| 주석/문서화 | 양호 | 핵심 로직에 주석 존재 |
| 상수 관리 | 양호 | auth.ts, SecurityConstants.java 등 |

### 7.2 보안 고려사항

| 항목 | 상태 | 비고 |
|------|------|------|
| HttpOnly 쿠키 | 양호 | XSS 방지 |
| SameSite 설정 | 양호 | Lax/None 적절히 적용 |
| JWT Secret | 주의 | 기본값 존재 (환경 변수 권장) |
| 세션 제한 | 양호 | 5개 제한, 오래된 세션 자동 삭제 |

### 7.3 사용자 경험

| 항목 | 상태 | 비고 |
|------|------|------|
| 로딩 상태 | 양호 | loading 상태 관리 |
| 에러 피드백 | 양호 | Toast 알림 사용 |
| 기기 관리 UI | 양호 | DeviceManagement 페이지 존재 |
| 로그인 상태 유지 | 양호 | keepLogin 옵션 제공 |

---

## 8. 결론

본 프로젝트는 전반적으로 잘 구조화되어 있으며, 인증/세션 관리의 핵심 기능은 정상 동작합니다.

### 주요 발견 사항

1. **WebSocket sessionId 미전달** - 기기 강퇴 기능에 영향
2. **만료된 토큰으로 WebSocket 연결 허용** - 보안 취약점
3. **인증 확인 캐싱에 TTL 없음** - 토큰 만료 감지 지연
4. **여러 기기 동시 접속 지원** - 설계가 올바름

### 개선 우선순위

1. **높음**: WebSocket sessionId 전달, WebSocket 인증 강화, 인증 캐싱 TTL
2. **중간**: 만료된 토큰 로그아웃 개선, 세션 알림 시스템
3. **낮음**: 이벤트 기반 아키텍처, lastAccessedAt 업데이트

### 레이스 컨디션에 대하여

현재 프로젝트에서 이미 일부 방지 메커니즘이 구현되어 있습니다:
- `isProcessingError` 플래그 (axiosConfig.ts)
- `isConnectingRef` 플래그 (WebSocketProvider.tsx)
- `isLoggedOutRef` 플래그 (WebSocketProvider.tsx)

이벤트 기반 아키텍처는 이러한 방지 메커니즘을 중앙화하여 더욱 견고하게 만들 수 있습니다.
