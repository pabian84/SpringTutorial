# ë¡œê·¸ì•„ì›ƒ í† ìŠ¤íŠ¸ ì¤‘ë³µ ë¬¸ì œ ë¶„ì„

## í˜„ì¬ ìƒí™©

1. `handleLogout()` ('ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ' í† ìŠ¤íŠ¸)
2. `onAuthFailed` ('ì¸ì¦ì‹¤íŒ¨, ë¡œê·¸ì•„ì›ƒ' í† ìŠ¤íŠ¸) â† **ë¬¸ì œ**

## ë¬¸ì œ ì›ì¸

`useDashboardData.ts`ì˜ React Queryê°€ logout ì¤‘ì—ë„ API ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤:

```typescript
const { data: onlineUsers = [] } = useQuery({
  queryKey: ['onlineUsers'], 
  queryFn: sessionApi.getOnlineUsers,
  enabled: !!myId,  // myIdê°€ ìˆìœ¼ë©´ ìš”ì²­ì„ ë³´ëƒ„!
});
```

logout í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ì—ë„ `myId`ê°€ `null`ì´ ì•„ë‹ˆë¯€ë¡œ, React Queryê°€ API ìš”ì²­ì„ ë³´ë‚´ê³  401ì´ ë°œìƒí•©ë‹ˆë‹¤.

## ì„¸ ê°€ì§€ ìˆ˜ì • ë°©ì•ˆ ë¹„êµ

### 1. logout í•¨ìˆ˜ì—ì„œ myIdë¥¼ ë¨¼ì € nullë¡œ ì„¤ì •

```typescript
const logout = useCallback(async (reason?: string) => {
  forceDisconnect();

  // âœ… ë¨¼ì € myIdë¥¼ nullë¡œ ì„¤ì • (React Query ìš”ì²­ ë°©ì§€)
  setAuthState(prev => ({ ...prev, user: null }));
  resetAuthCheck();

  if (reason) {
    showToast(reason, 'error');
  }

  try {
    await userApi.logout(undefined);
  } catch (e) {
    devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ API ì˜¤ë¥˜:', e);
  }

  navigate('/', { replace: true });
  devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
}, [navigate, forceDisconnect]);
```

**ì¥ì :**
- êµ¬í˜„éå¸¸ç®€å•
- React Queryê°€ ìš”ì²­ì„ ì•„ì˜ˆ ë³´ë‚´ì§€ ì•ŠìŒ

**ë‹¨ì :**
- logoutì´ ì‹¤íŒ¨í•˜ë©´ userê°€ null ìƒíƒœë¡œ ë‚¨ìŒ
- authStateë¥¼ ì§ì ‘ ì¡°ì‘í•´ì•¼ í•¨

---

### 2. React Queryì˜ enabledë¥¼ logout ì¤‘ì— falseë¡œ ì„¤ì •

```typescript
// AuthContextì— isLoggingOut ìƒíƒœ ì¶”ê°€
const [isLoggingOut, setIsLoggingOut] = useState(false);

const logout = useCallback(async (reason?: string) => {
  forceDisconnect();
  setIsLoggingOut(true);  // âœ… React Query ìš”ì²­ ë°©ì§€

  // ... ë‚˜ë¨¸ì§€ ì½”ë“œ

  setIsLoggingOut(false);
}, [navigate, forceDisconnect]);

// useDashboardData.tsì—ì„œ
const { user, logout, isLoggingOut } = useAuth();

const { data: onlineUsers = [] } = useQuery({
  queryKey: ['onlineUsers'], 
  queryFn: sessionApi.getOnlineUsers,
  enabled: !!myId && !isLoggingOut,  // âœ… logout ì¤‘ì´ë©´ ìš”ì²­ ì•ˆ í•¨
});
```

**ì¥ì :**
- React Query ë©”ì»¤ë‹ˆì¦˜ í™œìš©
- ëª…ì‹œì ì¸ ìƒíƒœ ê´€ë¦¬

**ë‹¨ì :**
- ë§ì€ íŒŒì¼ì„ ìˆ˜ì •í•´ì•¼ í•¨
- ìœ ì§€ë³´ìˆ˜ê°€ ë³µì¡í•´ì§

---

### 3. interceptorì—ì„œ isLoggingOut í”Œë˜ê·¸ í™œìš© (ì¶”ì²œ)

**í˜„ì¬ ë¬¸ì œ:** `handleLogout`ì´ `isLoggingOut`ì„ ì„¤ì •í•˜ì§€ ì•ŠìŒ

```typescript
// AuthProvider.tsx
const handleLogout = useCallback((reason?: string) => {
  // âŒ ë¬¸ì œ: isLoggingOutì„ ì„¤ì •í•˜ì§€ ì•ŠìŒ!
  logout(reason);
}, [logout]);
```

**ìˆ˜ì •:**

```typescript
// axiosConfig.tsì— isLoggingOut í”Œë˜ê·¸ ì¶”ê°€
let isLoggingOut = false;

export const isCurrentlyLoggingOut = () => isLoggingOut;

// interceptorì—ì„œ ì‚¬ìš©
if (isLoggingOut) {
  return false;  // 401ì„ ë¬´ì‹œ
}

// AuthProvider.tsx
const handleLogout = useCallback((reason?: string) => {
  isLoggingOut = true;  // âœ… ë¨¼ì € ì„¤ì •
  logout(reason);
}, [logout]);

const logout = useCallback(async (reason?: string) => {
  forceDisconnect();

  if (reason) {
    showToast(reason, 'error');
  }

  setAuthState({
    authenticated: false,
    user: null,
    loading: false,
  });

  resetAuthCheck();

  try {
    await userApi.logout(undefined);
  } catch (e) {
    devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ API ì˜¤ë¥˜:', e);
  }

  navigate('/', { replace: true });

  isLoggingOut = false;  // âœ… logout ì™„ë£Œ í›„ ë¦¬ì…‹
  devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
}, [navigate, forceDisconnect]);
```

**ì¥ì :**
- interceptor í•œ ê³³ë§Œ ìˆ˜ì •í•˜ë©´ ë¨
- ëª¨ë“  API ìš”ì²­ì— ì ìš©ë¨
- React Query ìˆ˜ì • ë¶ˆí•„ìš”

**ë‹¨ì :**
- ì „ì—­ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨ (ì•½ê°„ì˜ ê²°í•©)

---

## ê²°ë¡ 

| ê¸°ì¤€ | 1. myId null | 2. React Query enabled | 3. isLoggingOut í”Œë˜ê·¸ |
|------|--------------|------------------------|----------------------|
| **ë‹¨ìˆœì„±** | â­â­â­ | â­ | â­â­â­ |
| **ë³´ì•ˆ** | â­â­ | â­â­â­ | â­â­â­ |
| **ìœ ì§€ë³´ìˆ˜** | â­â­ | â­â­ | â­â­â­ |
| **í™•ì¥ì„±** | â­ | â­â­ | â­â­â­ |

### ğŸ† ì¶”ì²œ: **3ë²ˆ (isLoggingOut í”Œë˜ê·¸)**

ì´ìœ :
1. interceptor í•œ ê³³ì—ì„œ í•´ê²°
2. logout ì¤‘ì— ë°œìƒí•˜ëŠ” ëª¨ë“  401ì„ ë¬´ì‹œ
3. React Queryë¥¼ ìˆ˜ì •í•  í•„ìš” ì—†ìŒ
4. ë¯¸ë˜ì— ì¶”ê°€ë˜ëŠ” APIì—ë„ ìë™ ì ìš©

### êµ¬í˜„ ìˆœì„œ

1. `axiosConfig.ts`ì— `isLoggingOut` í”Œë˜ê·¸ ì¶”ê°€ ë° ë‚´ë³´ë‚´ê¸°
2. `AuthProvider.tsx`ì˜ `handleLogout`ì—ì„œ `isLoggingOut = true` ì„¤ì •
3. `logout` ì™„ë£Œ í›„ `isLoggingOut = false` ì„¤ì •
