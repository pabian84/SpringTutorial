# 레이스 컨디션 전체 분석

## 1. 분석 개요

본 문서는 v2 보고서의 모든 시나리오에서 발생할 수 있는 레이스 컨디션을 분석합니다.

### 1.1 분석 대상 시나리오

1. 로그인 시나리오
2. 로그아웃 시나리오
3. 토큰 만료 시나리오
4. 기기 강퇴(Kick) 시나리오
5. 다른 기기에서 로그인 (세션 초과) 시나리오

### 1.2 끼어들 수 있는 로직

1. **인증 로직**
   - `checkAuthStatus()` - authUtility.ts
   - `setupAxiosInterceptors()` - axiosConfig.ts
   - `useEffect` - AuthProvider.tsx (경로 변경, 마운트, 상태 변경)

2. **위젯 API 로직**
   - React Query - useDashboardData.ts
   - `useQuery` 호출 (onlineUsers, exchangeData, codeStats, memos, chatHistory)

3. **WebSocket 로직**
   - `connectSocket()` - WebSocketProvider.tsx
   - `forceReconnect()` / `forceDisconnect()`

---

## 2. 시나리오별 레이스 컨디션 분석

### 2.1 로그인 시나리오

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          로그인 시나리오 레이스 컨디션                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [정상 흐름]                                                                │
│  Login.tsx ──▶ AuthProvider.login() ──▶ POST /login ──▶ Set-Cookie        │
│       └──▶ setAuthState(authenticated: true) ──▶ navigate(/dashboard)      │
│                                                                             │
│  [레이스 컨디션 발생 지점]                                                   │
│                                                                             │
│  1. 로그인 API 호출 직후                                                    │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  login() 호출                                                    │   │
│     │      │                                                           │   │
│     │      ├─── POST /login (네트워크 요청)                            │   │
│     │      │                                                           │   │
│     │      │   [끼어들기 1] useEffect (경로 변경)                       │   │
│     │      │   └── checkAuthStatus() 호출                              │   │
│     │      │       └── 쿠키가 아직 설정되지 않음                        │   │
│     │      │           └── 401 반환                                    │   │
│     │      │               └── showToast: 로그인이 필요합니다          │   │
│     │      │                                                           │   │
│     │      ├─── 응답 도착 (Set-Cookie)                                 │   │
│     │      │                                                           │   │
│     │      └─── setAuthState(authenticated: true)                     │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. navigate(/dashboard) 직후                                               │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  navigate(/dashboard)                                            │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 2] useEffect (경로 변경)                      │   │
│     │      │   └── location.pathname = /dashboard                     │   │
│     │      │       └── checkAuthStatus() 호출                          │   │
│     │      │           └── 이미 인증됨 (정상)                          │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 3] React Query 활성화                        │   │
│     │      │   └── useDashboardData의 useQuery들                       │   │
│     │      │       └── API 호출 시작                                   │   │
│     │      │           └── 아직 쿠키가 완전히 설정되지 않았을 수 있음   │   │
│     │      │               └── 401 발생 가능                           │   │
│     │      │                                                           │   │
│     │      └─── Dashboard 렌더링                                       │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  3. forceReconnect() 직후                                                   │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  forceReconnect()                                                │   │
│     │      │                                                           │   │
│     │      ├─── WebSocket 연결 시도                                    │   │
│     │      │   └── checkAuthStatus() 호출 (connectSocket 내부)        │   │
│     │      │       └── 캐시된 결과 사용 (정상)                         │   │
│     │      │                                                           │   │
│     │      └─── WebSocket 연결 완료                                    │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**문제점:**
- `AuthProvider.tsx` line 136-156: `useEffect`가 `location.pathname` 변경 시마다 `checkAuthStatus()` 호출
- 로그인 API 응답 전에 이 useEffect가 실행되면 401 반환
- 불필요한 토스트: "로그인이 필요합니다, /dashboard"

**해결 방안:**
- 로그인 중에는 `checkAuthStatus()` 호출을 방지하는 플래그 필요
- 또는 경로 변경 useEffect 제거 (axios interceptor가 401 처리)

---

### 2.2 로그아웃 시나리오

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         로그아웃 시나리오 레이스 컨디션                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [정상 흐름]                                                                │
│  Dashboard ──▶ AuthProvider.logout() ──▶ forceDisconnect() ──▶ POST /logout│
│       └──▶ setAuthState(authenticated: false) ──▶ navigate(/)              │
│                                                                             │
│  [레이스 컨디션 발생 지점]                                                   │
│                                                                             │
│  1. forceDisconnect()와 POST /logout 사이                                  │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  forceDisconnect()                                               │   │
│     │      │                                                           │   │
│     │      ├─── WebSocket Close                                        │   │
│     │      │   └── onclose 이벤트                                      │   │
│     │      │       └── isAuthenticated() 호출                          │   │
│     │      │           └── 아직 true (로그아웃 전)                      │   │
│     │      │               └── 재연결 시도 (3초 후)                     │   │
│     │      │                                                           │   │
│     │      ├─── POST /logout                                           │   │
│     │      │   └── 서버에서 세션 삭제                                  │   │
│     │      │                                                           │   │
│     │      └─── setAuthState(authenticated: false)                     │   │
│     │           └── isLoggingOut = true 설정 필요                      │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. setAuthState(authenticated: false) 직후                                │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  setAuthState(authenticated: false)                              │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 1] useEffect (상태 변경)                      │   │
│     │      │   └── authState.authenticated = false                    │   │
│     │      │       └── navigate(/)                                    │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 2] React Query 비활성화                      │   │
│     │      │   └── isAuthenticatedRef.current = false                 │   │
│     │      │       └── 진행 중인 쿼리 취소                             │   │
│     │      │           └── 취소된 쿼리가 401 반환 가능                 │   │
│     │      │               └── axios interceptor가 처리                │   │
│     │      │                                                           │   │
│     │      └─── localStorage 정리                                      │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  3. WebSocket 재연결 시도 (3초 후)                                          │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  3초 후                                                          │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 3] 재연결 시도                               │   │
│     │      │   └── isLoggedOutRef.current 체크                        │   │
│     │      │       └── true면 재연결 중단 (정상)                       │   │
│     │      │           └── false면 재연결 시도                         │   │
│     │      │               └── checkAuthStatus() 호출                  │   │
│     │      │                   └── 401 반환                            │   │
│     │      │                       └── 불필요한 처리 발생              │   │
│     │      │                                                           │   │
│     │      └─── 아무 일도 일어나지 않음 (정상)                         │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**문제점:**
- `forceDisconnect()` 후 WebSocket `onclose`에서 재연결 타이머 설정
- `isLoggedOutRef.current = true`가 제때 설정되지 않으면 재연결 시도
- React Query 취소 시 401 에러가 axios interceptor에 전달

**해결 방안:**
- `forceDisconnect()`에서 먼저 `isLoggedOutRef.current = true` 설정
- `isLoggingOut` 플래그를 axios interceptor에서 확인

---

### 2.3 토큰 만료 시나리오

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         토큰 만료 시나리오 레이스 컨디션                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [정상 흐름]                                                                │
│  API 호출 ──▶ 401 반환 ──▶ axios interceptor ──▶ checkAuthStatus()         │
│       └──▶ 인증 실패 ──▶ onAuthFailed ──▶ 로그인 페이지                     │
│                                                                             │
│  [레이스 컨디션 발생 지점]                                                   │
│                                                                             │
│  1. 여러 API 동시 호출 시 토큰 만료                                         │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  [API 1] GET /sessions/online                                   │   │
│     │  [API 2] GET /finance/exchange                                  │   │
│     │  [API 3] GET /stats/code                                        │   │
│     │      │                                                           │   │
│     │      ├─── 모두 401 반환 (토큰 만료)                              │   │
│     │      │                                                           │   │
│     │      ├─── [문제] axios interceptor가 3번 실행                    │   │
│     │      │   └── isProcessingError 체크                              │   │
│     │      │       ├─── 첫 번째: true 설정 후 checkAuthStatus()       │   │
│     │      │       ├─── 두 번째: true이므로 큐에 추가                  │   │
│     │      │       └─── 세 번째: true이므로 큐에 추가                  │   │
│     │      │                                                           │   │
│     │      ├─── checkAuthStatus() 완료                                 │   │
│     │      │   └── 401 반환 (인증 실패)                                │   │
│     │      │       └── isLoggingOut = true                            │   │
│     │      │           └── 큐의 모든 요청 reject                       │   │
│     │      │               └── onAuthFailed 호출 (1번만)               │   │
│     │      │                                                           │   │
│     │      └─── 정상 처리 (중복 방지 작동)                             │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. 페이지 이동 중 토큰 만료                                                │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  navigate(/dashboard → /device)                                  │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 1] useEffect (경로 변경)                      │   │
│     │      │   └── checkAuthStatus() 호출                              │   │
│     │      │       └── 401 반환 (토큰 만료)                            │   │
│     │      │           └── showToast: 로그인이 필요합니다              │   │
│     │      │               └── resetAuthCheck()                        │   │
│     │      │                   └── navigate(/)                         │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 2] React Query (DeviceManagement)            │   │
│     │      │   └── GET /sessions                                      │   │
│     │      │       └── 401 반환                                        │   │
│     │      │           └── axios interceptor 실행                      │   │
│     │      │               └── isProcessingError = true                │   │
│     │      │                   └── checkAuthStatus() 호출              │   │
│     │      │                       └── 캐시된 결과 사용?               │   │
│     │      │                           └── 아니면 401                  │   │
│     │      │                                                               │
│     │      └─── 두 곳에서 동시에 로그인 페이지 이동 시도                 │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  3. WebSocket 연결 중 토큰 만료                                             │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  WebSocket 연결됨                                                │   │
│     │      │                                                           │   │
│     │      ├─── 토큰 만료                                              │   │
│     │      │                                                           │   │
│     │      ├─── [상황 1] 서버에서 WebSocket Close                      │   │
│     │      │   └── onclose 이벤트                                      │   │
│     │      │       └── isAuthenticated() 호출                          │   │
│     │      │           └── 401 반환                                    │   │
│     │      │               └── 재연결 중단                             │   │
│     │      │                   └── setIsConnected(false)               │   │
│     │      │                                                           │   │
│     │      ├─── [상황 2] 클라이언트에서 API 호출                        │   │
│     │      │   └── 401 반환                                            │   │
│     │      │       └── axios interceptor 실행                          │   │
│     │      │           └── onAuthFailed 호출                           │   │
│     │      │               └── showToast: 인증실패                     │   │
│     │      │                                                           │   │
│     │      └─── 두 경로에서 동시에 처리                                 │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**문제점:**
- `useEffect` (경로 변경)와 `axios interceptor`가 동시에 `checkAuthStatus()` 호출
- 두 곳에서 동시에 로그인 페이지 이동 시도
- WebSocket `onclose`와 API 401이 동시에 발생

**해결 방안:**
- 경로 변경 useEffect 제거 (axios interceptor가 처리)
- WebSocket `onclose`에서도 `isLoggingOut` 체크

---

### 2.4 기기 강퇴(Kick) 시나리오

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         기기 강퇴 시나리오 레이스 컨디션                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [정상 흐름]                                                                │
│  DeviceManagement ──▶ POST /revoke ──▶ SessionService.deleteSession()      │
│       └──▶ forceDisconnectWebSocket ──▶ WebSocket Close (4001)             │
│           └──▶ 강퇴된 기기에서 로그인 페이지로 이동                          │
│                                                                             │
│  [레이스 컨디션 발생 지점]                                                   │
│                                                                             │
│  1. 강퇴 실행 직후                                                          │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  POST /revoke                                                    │   │
│     │      │                                                           │   │
│     │      ├─── 서버에서 세션 삭제                                     │   │
│     │      │                                                           │   │
│     │      ├─── forceDisconnectWebSocket                               │   │
│     │      │   └── WebSocket Close (4001)                              │   │
│     │      │       └── 강퇴된 기기의 onclose 이벤트                     │   │
│     │      │           └── isAuthenticated() 호출                      │   │
│     │      │               └── 401 반환 (세션 없음)                     │   │
│     │      │                   └── 재연결 중단                         │   │
│     │      │                                                           │   │
│     │      └─── 응답 반환 (강퇴 완료)                                   │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. 강퇴된 기기에서의 처리                                                  │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline (강퇴된 기기)                                          │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  WebSocket Close (4001)                                          │   │
│     │      │                                                           │   │
│     │      ├─── onclose 이벤트                                         │   │
│     │      │   └── event.code = 4001                                   │   │
│     │      │       └── [문제] 4001 처리 로직이 없음                     │   │
│     │      │           └── 일반 재연결 시도 (3초 후)                    │   │
│     │      │               └── checkAuthStatus() 호출                  │   │
│     │      │                   └── 401 반환                            │   │
│     │      │                       └── 재연결 중단                     │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 1] 진행 중인 API 호출                         │   │
│     │      │   └── 401 반환 (세션 없음)                                │   │
│     │      │       └── axios interceptor 실행                          │   │
│     │      │           └── checkAuthStatus() 호출                      │   │
│     │      │               └── 401 반환                                │   │
│     │      │                   └── onAuthFailed 호출                   │   │
│     │      │                       └── showToast: 인증실패             │   │
│     │      │                                                           │   │
│     │      └─── 두 경로에서 동시에 처리                                 │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  3. WebSocket 메시지 처리                                                   │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  WebSocket 메시지 수신                                           │   │
│     │      │                                                           │   │
│     │      ├─── [문제] FORCE_LOGOUT 메시지 처리                        │   │
│     │      │   └── useDashboardData.ts line 171-178                   │   │
│     │      │       └── showToast: 다른 기기에서 접속하여...            │   │
│     │      │           └── resetAuthCheck()                            │   │
│     │      │               └── navigate(/)                             │   │
│     │      │                   └── [문제] logout() 호출 안 함           │   │
│     │      │                       └── 서버에 세션이 남아있을 수 있음   │   │
│     │      │                                                           │   │
│     │      └─── WebSocket Close와 메시지가 동시에 올 수 있음           │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**문제점:**
- WebSocket Close Code 4001에 대한 특별 처리가 없음
- `FORCE_LOGOUT` 메시지 처리에서 `logout()`을 호출하지 않음
- WebSocket Close와 API 401이 동시에 발생

**해결 방안:**
- WebSocket `onclose`에서 4001 코드 특별 처리
- `FORCE_LOGOUT` 메시지에서 `logout()` 호출

---

### 2.5 다른 기기에서 로그인 (세션 초과) 시나리오

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      세션 초과 시나리오 레이스 컨디션                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [정상 흐름]                                                                │
│  새 기기 로그인 ──▶ 세션 5개 초과 ──▶ 가장 오래된 세션 삭제                  │
│       └──▶ forceDisconnectWebSocket ──▶ 기존 기기 WebSocket Close          │
│           └──▶ 기존 기기에서 로그인 페이지로 이동                            │
│                                                                             │
│  [레이스 컨디션 발생 지점]                                                   │
│                                                                             │
│  1. 새 기기 로그인과 기존 기기 강퇴                                          │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline                                                        │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  [새 기기]                          [기존 기기]                  │   │
│     │      │                                   │                       │   │
│     │      ├─── POST /login                    │                       │   │
│     │      │                                   │                       │   │
│     │      ├─── 세션 5개 초과 확인             │                       │   │
│     │      │                                   │                       │   │
│     │      ├─── 가장 오래된 세션 삭제          │                       │   │
│     │      │   (기존 기기의 세션)              │                       │   │
│     │      │                                   │                       │   │
│     │      ├─── forceDisconnectWebSocket ──────┼──▶ WebSocket Close    │   │
│     │      │                                   │       (4001)          │   │
│     │      │                                   │           │           │   │
│     │      │                                   │           └── onclose │   │
│     │      │                                   │               이벤트  │   │
│     │      │                                   │                   │   │   │
│     │      ├─── 새 세션 생성                   │   [끼어들기 1]       │   │
│     │      │                                   │   API 호출 중       │   │
│     │      │                                   │       └── 401 반환  │   │
│     │      │                                   │           │         │   │
│     │      ├─── Set-Cookie                     │           └── axios │   │
│     │      │                                   │               interc.│   │
│     │      │                                   │                   │   │   │
│     │      └─── 로그인 완료                    │   [끼어들기 2]       │   │
│     │                                          │   useEffect 실행    │   │
│     │                                          │       └── checkAuth│   │
│     │                                          │           └── 401   │   │
│     │                                          │               │     │   │
│     │                                          │               └── nav│   │
│     │                                          │                   /  │   │
│     │                                          │                       │   │
│     │                                          └─── 로그인 페이지로   │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. 기존 기기에서의 동시 처리                                               │
│     ┌──────────────────────────────────────────────────────────────────┐   │
│     │  Timeline (기존 기기)                                            │   │
│     │  ──────────────────────────────────────────────────────────────  │   │
│     │  WebSocket Close (4001)                                          │   │
│     │      │                                                           │   │
│     │      ├─── onclose 이벤트                                         │   │
│     │      │   └── isAuthenticated() 호출                              │   │
│     │      │       └── 401 반환                                        │   │
│     │      │           └── 재연결 중단                                 │   │
│     │      │               └── setIsConnected(false)                   │   │
│     │      │                   └── [문제] 로그인 페이지 이동 안 함      │   │
│     │      │                                                           │   │
│     │      ├─── [끼어들기 1] 진행 중인 API                              │   │
│     │      │   └── 401 반환                                            │   │
│     │      │       └── axios interceptor                               │   │
│     │      │           └── onAuthFailed                                │   │
│     │      │               └── showToast: 인증실패                     │   │
│     │      │                   └── navigate(/)                         │   │
│     │      │                                                           │   │
│     │      └─── 두 경로에서 처리되지만 로그인 페이지 이동은 1번         │   │
│     └──────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**문제점:**
- WebSocket Close만으로는 로그인 페이지 이동이 안 됨
- API 401이나 useEffect에서 처리해야 함
- 여러 곳에서 동시에 처리 시도

**해결 방안:**
- WebSocket `onclose`에서 4001 코드 시 로그인 페이지 이동
- 또는 `FORCE_LOGOUT` 메시지에 의존

---

## 3. 근본 원인 요약

### 3.1 핵심 문제

1. **중복 인증 확인**
   - `useEffect` (경로 변경) + `axios interceptor` + `WebSocket onclose`
   - 세 곳에서 독립적으로 `checkAuthStatus()` 호출

2. **상태 동기화 부재**
   - 로그인/로그아웃 중간에 다른 로직이 끼어들 수 있음
   - 플래그(`isLoggingOut`, `isProcessingError`)가 분산되어 있음

3. **WebSocket Close Code 처리 미흡**
   - 4001 (Force Logout)에 대한 특별 처리가 없음
   - `FORCE_LOGOUT` 메시지와 Close 이벤트가 별개로 처리됨

### 3.2 불필요한 메시지 발생 상황

| 상황 | 발생 메시지 | 원인 |
|------|-------------|------|
| 로그인 중 | "로그인이 필요합니다" | useEffect가 checkAuthStatus 호출 |
| 로그아웃 중 | "인증실패" | axios interceptor가 401 처리 |
| 토큰 만료 | "로그인이 필요합니다" + "인증실패" | useEffect + interceptor 동시 실행 |
| 기기 강퇴 | "인증실패" | interceptor가 401 처리 |
| 세션 초과 | "인증실패" | interceptor가 401 처리 |

---

## 4. 해결 방안

### 4.1 Phase 1: 중복 인증 확인 제거

1. **경로 변경 useEffect 제거**
   - `AuthProvider.tsx` line 136-156 제거
   - axios interceptor가 401 처리

2. **WebSocket onclose 개선**
   - 4001 코드 특별 처리
   - `isLoggingOut` 체크

### 4.2 Phase 2: 상태 동기화 강화

1. **로그인 플래그 추가**
   ```typescript
   const isLoggingInRef = useRef(false);
   ```

2. **로그아웃 플래그 일원화**
   - `isLoggingOut`을 authUtility로 이동
   - 모든 곳에서 동일한 플래그 참조

### 4.3 Phase 3: 이벤트 기반 아키텍처 (선택)

1. **중앙 이벤트 버스 구현**
   - 인증 상태 변경을 이벤트로 관리
   - 모든 리스너가 동일한 이벤트 수신

2. **상태 전이 명확화**
   - 로그인 시작 → 로그인 완료
   - 로그아웃 시작 → 로그아웃 완료
   - 토큰 만료 감지 → 로그아웃

---

## 5. 실행 계획

### 5.1 즉시 실행 (Phase 1)

1. `AuthProvider.tsx`: 경로 변경 useEffect 제거
2. `WebSocketProvider.tsx`: 4001 코드 처리 추가
3. `useDashboardData.ts`: FORCE_LOGOUT에서 logout() 호출

### 5.2 후속 실행 (Phase 2)

1. 로그인 플래그 추가
2. 로그아웃 플래그 일원화
3. 불필요한 토스트 제거

### 5.3 장기 개선 (Phase 3)

1. 이벤트 버스 구현
2. 상태 전이 다이어그램 구현
