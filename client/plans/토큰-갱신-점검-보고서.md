# Memory-based Token Expiration 점검 보고서

## 1. 코드 수정 내역

### 1.1 authUtility.ts
| 항목 | 상태 | 비고 |
|------|------|------|
| `tokenExpiresAt` 메모리 변수 | ✅ 정상 | localStorage 대신 메모리 사용 |
| `setTokenExpiration()` | ✅ 정상 | 초 단위 → 밀리초 변환 저장 |
| `clearTokenExpiration()` | ✅ 정상 | null로 초기화 |
| `isTokenExpiringSoon()` | ✅ 정상 | 6분 임계값 (30분의 20%) |
| `refreshToken()` | ✅ 정상 | Promise 중복 방지, expiresIn 업데이트 |
| `checkAuthStatus()` | ✅ 정상 | 서버 응답 expiresIn으로 복구 |

### 1.2 axiosConfig.ts
| 항목 | 상태 | 비고 |
|------|------|------|
| import 함수 | ✅ 정상 | 6개 함수 모두 import |
| PUBLIC_ENDPOINTS | ✅ 정상 | `/api/auth/refresh` 포함 |
| Proactive Refresh | ✅ 정상 | 요청 전 만료 임박 체크 |

### 1.3 AuthProvider.tsx
| 항목 | 상태 | 비고 |
|------|------|------|
| import 함수 | ✅ 정상 | 6개 함수 모두 import |
| 로그인 시 expiresIn 사용 | ✅ 정상 | 서버 응답 값 사용 |
| 로그아웃 시 clear 호출 | ✅ 정상 | clearTokenExpiration() 호출 |

### 1.4 dtos.ts
| 항목 | 상태 | 비고 |
|------|------|------|
| LoginResDTO.expiresIn | ✅ 추가 | optional number 타입 |

---

## 2. 시나리오별 검증

### 2.1 로그인 시나리오
```
1. 사용자 로그인 요청
2. 서버: accessToken (httpOnly Cookie) + expiresIn 응답
3. AuthProvider: setTokenExpiration(expiresIn) 호출
4. 메모리 변수에 만료 시간 저장
```
**결과**: ✅ 정상 동작

### 2.2 페이지 새로고침 시나리오
```
1. 페이지 새로고침 발생
2. 메모리 변수 tokenExpiresAt 초기화 (null)
3. AuthProvider useEffect: checkAuthStatus() 호출
4. 서버 응답: { authenticated: true, user, expiresIn }
5. checkAuthStatus 내부: setTokenExpiration(expiresIn) 호출
6. 메모리 변수 복구
```
**결과**: ✅ 정상 동작

### 2.3 Proactive Refresh 시나리오
```
1. API 요청 발생 (예: /api/widgets/weather)
2. axios 요청 인터셉터: isTokenExpiringSoon() 체크
3. 만료 6분 전이면 refreshToken() 호출
4. 서버: 새 accessToken + expiresIn 응답
5. refreshToken 내부: setTokenExpiration(expiresIn) 호출
6. 원래 요청 계속 진행
```
**결과**: ✅ 정상 동작

### 2.4 다중 탭 시나리오
```
탭 A: 독립적인 tokenExpiresAt 변수
탭 B: 독립적인 tokenExpiresAt 변수

각 탭이 독립적으로:
- checkAuthStatus()로 만료 시간 복구
- Proactive Refresh 수행
- 경쟁 상태 없음
```
**결과**: ✅ 정상 동작

### 2.5 로그아웃 시나리오
```
1. 사용자 로그아웃 요청
2. AuthProvider: clearTokenExpiration() 호출
3. 메모리 변수 null로 초기화
4. 이후 API 요청 시 isTokenExpiringSoon() → false
```
**결과**: ✅ 정상 동작

---

## 3. 기존 기능 영향 분석

### 3.1 영향 없는 기능
- ✅ 로그인/로그아웃 플로우
- ✅ 401/403 에러 처리
- ✅ WebSocket 연결/해제
- ✅ 인증 상태 캐싱 (TTL 5초)
- ✅ React Query 연동 (isAuthenticatedRef)

### 3.2 개선된 기능
- ✅ XSS 공격 방지 (localStorage 미사용)
- ✅ "로그인 상태 유지" 기능과 충돌 없음
- ✅ 다중 탭 환경에서 경쟁 상태 제거

---

## 4. 잠재적 문제점

### 4.1 메모리 기반의 한계
| 상황 | 동작 | 해결책 |
|------|------|--------|
| 페이지 새로고침 | 만료 시간 손실 | checkAuthStatus()로 복구 |
| 브라우저 탭 복원 | 만료 시간 손실 | checkAuthStatus()로 복구 |

**평가**: 서버 응답 기반 복구로 문제 없음

### 4.2 Proactive Refresh 타이밍
| 토큰 유효시간 | 갱신 임계값 | 갱신 시점 |
|---------------|-------------|-----------|
| 30분 (일반) | 6분 | 24분 경과 시 |
| 7일 (로그인 유지) | 6분 | 6분 전 |

**평가**: 로그인 유지 시 너무 이르게 갱신될 수 있음
**개선 필요**: 동적 임계값 (전체 시간의 20%) 적용 고려

---

## 5. 결론

### 5.1 수정 완료 항목
- [x] localStorage → 메모리 변수 변경
- [x] BroadcastChannel 제거
- [x] 서버 응답 expiresIn 활용
- [x] Proactive Refresh 로직 유지
- [x] 기존 기능 손상 없음

### 5.2 권장 사항
1. **동적 임계값 적용**: `expiresIn * 0.2`로 계산
2. **테스트 코드 작성**: 토큰 갱신 시나리오 테스트
3. **모니터링**: 갱신 빈도 로그 수집

---

## 6. 파일 변경 요약

| 파일 | 변경 유형 | 주요 내용 |
|------|-----------|-----------|
| `authUtility.ts` | 재작성 | 메모리 기반 토큰 만료 관리 |
| `AuthProvider.tsx` | 수정 | 서버 응답 expiresIn 사용 |
| `dtos.ts` | 수정 | LoginResDTO에 expiresIn 추가 |
| `axiosConfig.ts` | 유지 | Proactive Refresh 로직 유지 |
