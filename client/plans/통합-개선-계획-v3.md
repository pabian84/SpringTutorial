# 통합 개선 계획 v3

## 1. v2 보고서 완료 현황

### 1.1 완료된 항목 ✅

| 항목 | 우선순위 | 상태 | 비고 |
|------|----------|------|------|
| WebSocket sessionId 전달 수정 | 높음 | ✅ 완료 | JwtHandshakeInterceptor.java |
| WebSocket 인증 강화 | 높음 | ✅ 완료 | DB 세션 존재 확인 추가 |
| 인증 캐싱 TTL 추가 | 높음 | ✅ 완료 | authUtility.ts (5초 TTL) |
| 만료된 토큰 로그아웃 개선 | 중간 | ✅ 완료 | UserController.java |
| lastAccessedAt 업데이트 | 낮음 | ✅ 완료 | SessionMapper + JwtAuthenticationFilter |

### 1.2 부분 완료 항목 ⚠️

| 항목 | 우선순위 | 상태 | 비고 |
|------|----------|------|------|
| 세션 알림 시스템 | 중간 | ⚠️ 부분 | 이벤트 발행은 되나 리스너 미작동 |

### 1.3 미완료 항목 ❌

| 항목 | 우선순위 | 상태 | 비고 |
|------|----------|------|------|
| 이벤트 기반 아키텍처 도입 | 낮음 | ❌ 미완료 | 레이스 컨디션 근본 해결 |
| 에러 바운더리 강화 | - | ❌ 미완료 | v2 보고서에서 언급되었으나 계획 누락 |
| CORS/쿠키 보안 설정 환경 변수화 | - | ❌ 미완료 | v2 보고서에서 언급되었으나 계획 누락 |

---

## 2. 인증 로직 정리 계획에서 누락된 항목

### 2.1 v2 보고서에서 승계되지 않은 항목

1. **이벤트 기반 아키텍처 도입** (낮은 우선순위)
   - 현재: 개별 플래그로 레이스 컨디션 방지
   - 개선: 중앙 이벤트 버스로 일관성 있는 상태 관리

2. **에러 바운더리 강화**
   - 현재: ErrorBoundary 컴포넌트 존재
   - 개선: 인증 관련 에러에 대한 특화 처리

3. **CORS 및 쿠키 보안 설정 환경 변수화**
   - 현재: application.yml에 하드코딩
   - 개선: 환경 변수로 분리

### 2.2 근본 원인 분석

사용자 피드백: "불필요한 메시지가 발생하는 상황 자체가 문제"

**근본 원인: 레이스 컨디션과 상태 동기화 문제**

```
문제 시나리오:
1. 로그인 API 호출
2. 응답 도착 전에 다른 useEffect에서 checkAuthStatus() 호출
3. 아직 쿠키가 설정되지 않아 401 반환
4. axios interceptor가 이를 인증 실패로 처리
5. 불필요한 토스트 표시
```

---

## 3. 통합 개선 계획

### 3.1 Phase 1: 근본 원인 해결 (최우선)

#### 3.1.1 인증 상태 동기화 문제 해결

**문제**: 여러 곳에서 동시에 인증 확인 호출

**해결 방안**:
```typescript
// AuthProvider.tsx
// Before: 두 개의 useEffect가 각각 인증 확인
useEffect(() => { checkAuthStatus() }, [location.pathname]);  // 제거
useEffect(() => { checkAuthStatus() }, []);  // 유지

// After: 마운트 시에만 인증 확인
// 페이지 이동 시에는 axios interceptor가 401을 처리
```

#### 3.1.2 로그인/로그아웃 상태 전이 명확화

**문제**: 로그인 중간에 다른 인증 확인이 끼어듦

**해결 방안**:
```typescript
// AuthProvider.tsx
const login = async () => {
  // 1. 로그인 시작 플래그 설정
  isLoggingInRef.current = true;
  
  // 2. 로그인 API 호출
  await userApi.login(...);
  
  // 3. 상태 업데이트
  setAuthState({ authenticated: true, ... });
  
  // 4. 로그인 완료 플래그 해제
  isLoggingInRef.current = false;
};
```

### 3.2 Phase 2: 불필요한 로직 제거

#### 3.2.1 axiosConfig.ts
- [ ] `showToast('요청 인터셉터')` 제거 (line 157)
- [ ] 404 토스트 제거 (line 226) - 자원 문제는 각 컴포넌트에서 처리

#### 3.2.2 AuthProvider.tsx
- [ ] 중복 인증 확인 useEffect 제거 (line 136-156)
- [ ] 불필요한 토스트 제거 (line 152, 168)
- [ ] 주석 처리된 코드 제거 (line 169)

### 3.3 Phase 3: 이벤트 기반 아키텍처 도입 (선택)

**목적**: 레이스 컨디션 근본 해결

**구현 방안**:
```typescript
// eventBus.ts
class AuthEventBus {
  private static instance: AuthEventBus;
  private eventQueue: AuthEvent[] = [];
  private processing = false;

  static getInstance() { ... }
  
  async emit(event: AuthEvent) {
    this.eventQueue.push(event);
    await this.processQueue();
  }
}
```

### 3.4 Phase 4: 보안 설정 환경 변수화 (선택)

**대상**:
- CORS 설정
- 쿠키 SameSite 설정
- JWT Secret

---

## 4. 실행 순서

1. **Phase 1**: 근본 원인 해결 (인증 상태 동기화)
2. **Phase 2**: 불필요한 로직 제거
3. **Phase 3**: 이벤트 기반 아키텍처 (선택)
4. **Phase 4**: 보안 설정 환경 변수화 (선택)

---

## 5. 예상 효과

1. **토스트 메시지 감소**: 인증 관련 토스트가 정확한 상황에만 표시
2. **불필요한 API 호출 감소**: 페이지 이동 시마다 인증 확인하지 않음
3. **레이스 컨디션 해결**: 상태 전이가 명확해짐
4. **코드 가독성 향상**: 중복 로직 제거

---

## 6. 사용자 승인 필요 사항

1. Phase 1, 2는 즉시 진행 권장
2. Phase 3, 4는 선택 사항 (장기 개선)
3. 세션 알림 시스템은 추가 디버깅 필요
