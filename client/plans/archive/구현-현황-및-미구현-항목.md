# 구현 현황 및 미구현 항목

## 1. 변경 사항 요약

### 1.1 SessionService.java (변경됨)

| 변경 전 | 변경 후 | 상태 |
|--------|--------|------|
| `removeSession()` | `removeWebSocket()` | ✅ 구현됨 |
| `forceDisconnectOne()` | `forceDisconnectWebSocket(String userId, Long targetSessionId)` | ✅ 구현됨 |
| (새 메서드) | `forceDisconnectWebSocket(Long sessionId)` | ✅ 구현됨 |
| `getUserIdFromSession()` | `getUserIdFromWebSocketSession()` | ✅ 구현됨 |

### 1.2 UserController.java (부분 변경됨)

| 항목 | 상태 | 비고 |
|------|------|------|
| sessionId 없으면 logoutAll 안 함 | ✅ 구현됨 | line 107-111 |
| `forceDisconnectWebSocket(Long sessionId)` 사용 | ❌ 미구현 | 현재 userId 버전 사용 중 |
| 로그 메시지 추가 | ✅ 구현됨 | line 105, 109 |

## 2. 미구현 항목

### 2.1 UserController.java - 새 메서드 사용

**현재 코드 (line 104):**
```java
sessionService.forceDisconnectWebSocket(userId, sessionId);  // ❌舊버전
```

**수정 필요:**
```java
sessionService.forceDisconnectWebSocket(sessionId);  // ✅新버전
```

**이유:**
- `forceDisconnectWebSocket(Long sessionId)`는 sessionId만으로 WebSocket을 찾아断开
- `forceDisconnectWebSocket(String userId, Long targetSessionId)`는 userId로 먼저查找

### 2.2 UserService.logout() - 로그 추가

**현재:** 로그 없음

**수정 필요:**
```java
public void logout(String userId, Long sessionId, String userAgent, String ipAddress) {
    sessionMapper.deleteBySessionId(sessionId);
    
    // ✅ 로그 추가
    log.info("세션 삭제됨: userId={}, sessionId={}, device={}, ip={}", 
             userId, sessionId, userAgent, ipAddress);
    
    accessLogService.saveLog(userId, sessionId, 
                            SecurityConstants.TYPE_LOGOUT, null, null, ipAddress, userAgent);
}
```

### 2.3 SessionService.deleteSession() - 로그 추가

**현재 (line 96):**
```java
log.warn("delete " + currentUserId + ", targetSessionId: " + targetSessionId);
```

**수정 필요:**
```java
log.info("관리자 세션 삭제: admin={}, targetUserId={}, sessionId={}", 
         currentUserId, targetSession.getUserId(), targetSessionId);
```

### 2.4 SessionService.deleteAllSessions() - 로그 추가

**현재:** 로그 없음

**수정 필요:**
```java
log.info("전체 세션 삭제됨: userId={}", userId);
```

### 2.5 Frontend - WebSocket 닫기

**WebSocketProvider.tsx:** `forceDisconnect()` 함수 추가 필요

**AuthProvider.tsx:** `logout()`에서 `forceDisconnect()` 호출 필요

## 3. 구현 우선순위

### 3.1 高우선순위 (Backend 핵심 로직)

1. **UserController.java** - 새 메서드 사용
2. **UserService.logout()** - 로그 추가

### 3.2 中우선순위 (Logging)

3. **SessionService.deleteSession()** - 로그 추가
4. **SessionService.deleteAllSessions()** - 로그 추가

### 3.3 低우선순위 (Frontend)

5. **WebSocketProvider.tsx** - forceDisconnect() 함수 추가
6. **AuthProvider.tsx** - logout()에서 forceDisconnect() 호출

## 4. 체크리스트

### Backend

- [ ] UserController.java line 104: `forceDisconnectWebSocket(userId, sessionId)` → `forceDisconnectWebSocket(sessionId)`
- [ ] UserService.logout(): 로그 추가
- [ ] SessionService.deleteSession(): 로그 수정
- [ ] SessionService.deleteAllSessions(): 로그 추가

### Frontend

- [ ] WebSocketProvider.tsx: `forceDisconnect()` 함수 추가
- [ ] AuthProvider.tsx: `logout()`에서 `forceDisconnect()` 호출

## 5. 예상 로그 출력 (최종)

### 정상 로그아웃

```
[Backend] 세션 삭제됨: userId=hong, sessionId=993, device=Chrome, ip=0:0:0:0:0:0:0:1
[Backend] WebSocket 강제 종료: UserId=hong, SessionId=993
[Backend] 로그아웃 완료: userId=hong, sessionId=993
```

### sessionId 없는 경우

```
[Backend] 로그아웃 요청: sessionId 없음, userId=hong
```

### 관리자 세션 삭제

```
[Backend] 관리자 세션 삭제: admin=admin, targetUserId=hong, sessionId=993
```
