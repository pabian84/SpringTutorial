# ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ ë¶„ì„ ë³´ê³ ì„œ (v2 ì—…ë°ì´íŠ¸)

## 1. í•µì‹¬ ë°œê²¬ ì‚¬í•­ (ìˆ˜ì •)

### ì´ì „ ë¶„ì„ ì˜¤ë¥˜

ê¸°ì¡´ ë¶„ì„ì—ì„œ **ì˜ëª»ëœ ê²°ë¡ **ì„ ë„ì¶œí–ˆìŠµë‹ˆë‹¤:

> âŒ "ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ â†’ `/api/user/logout` â†’ JwtFilterì—ì„œ ì°¨ë‹¨"

### ì‹¤ì œ ë¬¸ì œ

ì‚¬ìš©ì í”¼ë“œë°±ì—ì„œ ë°œê²¬í•œ ì§„ì§œ ì—ëŸ¬:
```
ì°¨ë‹¨ë¨(http://localhost:8080/api/auth/check): DBì— ì—†ëŠ” ì„¸ì…˜ì…ë‹ˆë‹¤. (ì´ë¯¸ ë¡œê·¸ì•„ì›ƒë¨) - ID: 993
```

**`/api/auth/check`ì—ì„œ ì—ëŸ¬ ë°œìƒ!**

```mermaid
sequenceDiagram
    participant User
    participant AuthProvider
    participant Axios
    participant JwtFilter
    participant AuthController
    
    Note over User,AuthController: ì‹¤ì œ ë°œìƒ íë¦„
    
    User->>AuthProvider: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­
    
    rect rgb(255, 200, 200)
        Note: 1. logout() í•¨ìˆ˜ ì‹¤í–‰
        
        AuthProvider->>AuthProvider: authState = false
        AuthProvider->>AuthProvider: resetAuthCheck()
        AuthProvider->>Axios: POST /api/user/logout
        AuthProvider->>AuthProvider: navigate('/')
    end
    
    Note over AuthProvider: navigate('/') í˜¸ì¶œ<br/>location.pathname ë³€ê²½
    
    rect rgb(255, 200, 200)
        Note: 2. useEffect ì¬ì‹¤í–‰ â†’ checkAuthStatus() í˜¸ì¶œ
        
        AuthProvider->>AuthUtility: checkAuthStatus()
        AuthUtility->>Axios: GET /api/auth/check
        Axios->>JwtFilter: ìš”ì²­ ì „ë‹¬
    end
    
    Note over JwtFilter: JwtFilterëŠ” ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì‹¤í–‰ë¨<br/>(shouldNotFilterì— /api/auth/check ì—†ìŒ)
    
    rect rgb(255, 200, 200)
        Note: 3. JwtFilterì—ì„œ ì„¸ì…˜ ê²€ì¦
        
        JwtFilter->>JwtFilter: í† í° ì¶”ì¶œ (ì¿ í‚¤ì—ì„œ)
        JwtFilter->>JwtFilter: í† í° ê²€ì¦ (ìœ íš¨í•¨!)
        JwtFilter->>JwtFilter: sessionId = 993 ì¶”ì¶œ
        JwtFilter->>SessionMapper: findBySessionId(993)
        
        SessionMapper-->>JwtFilter: null (ì„¸ì…˜ì´ DBì— ì—†ìŒ!)
        
        JwtFilter-->>Axios: 401 Unauthorized
        Note right of JwtFilter: "ì°¨ë‹¨ë¨: DBì— ì—†ëŠ” ì„¸ì…˜ì…ë‹ˆë‹¤"
    end
    
    Axios-->>AuthUtility: 401 ì—ëŸ¬
    AuthUtility-->>AuthProvider: authenticated = false
    
    rect rgb(255, 200, 200)
        Note: 4. handleLogout() ì¤‘ë³µ í˜¸ì¶œ
        
        AuthProvider->>AuthProvider: handleLogout("ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.")
        AuthProvider->>AuthProvider: logout() ì¬ì‹¤í–‰
        AuthProvider->>Axios: POST /api/user/logout
        Note AuthProvider: âš ï¸ ì¤‘ë³µ ë¡œê·¸ì•„ì›ƒ!
    end
```

## 2. Root Cause ë¶„ì„

### 2.1 `/api/auth/check`ê°€ JwtFilterë¥¼ í†µê³¼í•¨

```java
// JwtAuthenticationFilter.java
@Override
protected boolean shouldNotFilter(HttpServletRequest request) {
    return "/api/user/login".equals(request.getRequestURI());
    // âŒ /api/auth/checkê°€ ì œì™¸ë˜ì§€ ì•ŠìŒ!
}
```

`/api/auth/check`ëŠ” **JwtFilterë¥¼ ê±°ì¹˜ê²Œ ë©ë‹ˆë‹¤**.

### 2.2 ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ (ìƒì„¸)

```mermaid
sequenceDiagram
    participant User
    participant AuthProvider
    participant AuthUtility
    participant Axios
    participant JwtFilter
    participant SessionMapper
    participant AuthController
    participant UserController
    
    Note over User,UserController: íƒ€ì„ë¼ì¸ (ë¬¸ì œ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤)
    
    rect rgb(240, 248, 255)
        Note: t=0: ë¡œê·¸ì•„ì›ƒ ì‹œì‘
    end
    
    User->>AuthProvider: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­
    AuthProvider->>AuthProvider: setAuthState(authenticated=false)
    AuthProvider->>AuthProvider: resetAuthCheck()
    
    par ë³‘ë ¬ ì‹¤í–‰
        AuthProvider->>Axios: POST /api/user/logout
        Note right of AuthProvider: navigate('/') í˜¸ì¶œ
        AuthProvider->>AuthProvider: navigate('/')
    end
    
    Note over AuthProvider: location.pathname ë³€ê²½<br/>â†’ useEffect ì¬ì‹¤í–‰
    
    AuthProvider->>AuthUtility: checkAuthStatus()
    AuthUtility->>Axios: GET /api/auth/check
    
    par /api/user/logout
        Axios->>JwtFilter: /api/user/logout ìš”ì²­
        JwtFilter->>JwtFilter: í† í° ê²€ì¦
        JwtFilter->>SessionMapper: findBySessionId
        SessionMapper-->>JwtFilter: ì„¸ì…˜ ì¡´ì¬ âœ“
        JwtFilter->>UserController: ìš”ì²­ í†µê³¼
        UserController->>UserController: ì„¸ì…˜ ì‚­ì œ
        UserController->>SessionMapper: deleteBySessionId(993)
        SessionMapper-->>UserController: ì‚­ì œ ì™„ë£Œ
        UserController-->>Axios: 200 OK
    and /api/auth/check
        Axios->>JwtFilter: /api/auth/check ìš”ì²­
        JwtFilter->>JwtFilter: í† í° ê²€ì¦
        JwtFilter->>JwtFilter: sessionId = 993 ì¶”ì¶œ
        JwtFilter->>SessionMapper: findBySessionId(993)
        
        SessionMapper-->>JwtFilter: null (ì´ë¯¸ ì‚­ì œë¨!)
        
        JwtFilter-->>Axios: 401 Unauthorized
        Note right of JwtFilter: ğŸ’¥ ì„¸ì…˜ì´ ì´ë¯¸ ì‚­ì œë¨!
    end
    
    Note over Axios: /api/auth/checkê°€ ë¨¼ì € ì²˜ë¦¬ë¨<br/>race condition!
    
    Axios-->>AuthUtility: 401 ì—ëŸ¬
    AuthUtility-->>AuthProvider: authenticated=false
    
    rect rgb(255, 200, 200)
        Note: ğŸ’¥ ë¬¸ì œ: handleLogout() ì¤‘ë³µ í˜¸ì¶œ
        
        AuthProvider->>AuthProvider: onAuthFailed("ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.")
        AuthProvider->>AuthProvider: handleLogout("ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.")
        AuthProvider->>Axios: POST /api/user/logout (ì¤‘ë³µ!)
        Note AuthProvider: ì´ë¯¸ ì‚­ì œëœ ì„¸ì…˜ì— ëŒ€í•´<br/>ë‹¤ì‹œ ì‚­ì œ ì‹œë„
    end
```

## 3. Race Condition ìƒì„¸ ë¶„ì„

### 3.1 ë°œìƒ ì¡°ê±´

```mermaid
flowchart TD
    A[ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ] --> B{ì–´ë–¤ ìˆœì„œë¡œ ì²˜ë¦¬?}
    B -->|userLogout â†’ authCheck ìˆœì°¨ì | C[ì •ìƒ ì²˜ë¦¬]
    B -->|userLogoutê³¼ authCheck ë™ì‹œ| D[Race Condition]
    B -->|authCheckê°€ ë¨¼ì €| D
    
    C --> C1[ì„¸ì…˜ ì‚­ì œ í›„ authCheck<br/>â†’ í† í° ì—†ìŒ â†’ 401 ì •ìƒ]
    D --> D1[/api/auth/checkê°€ ë¨¼ì € ì²˜ë¦¬ë¨<br/>â†’ ì„¸ì…˜ì´ ì‚­ì œë˜ê¸° ì „<br/>â†’ ì„¸ì…˜ ì¡´ì¬ â†’ í†µê³¼]
    
    D --> D2[/api/auth/checkê°€ ë‚˜ì¤‘ì— ì²˜ë¦¬ë¨<br/>â†’ ì„¸ì…˜ì´ ì´ë¯¸ ì‚­ì œë¨<br/>â†’ ğŸ’¥ 401 "ì°¨ë‹¨ë¨: DBì— ì—†ëŠ” ì„¸ì…˜"]
    
    D2 --> E[ì¤‘ë³µ ë¡œê·¸ì•„ì›ƒ ì‹œë„]
```

### 3.2 ì™œ 401ì´ ë°˜í™˜ë˜ëŠ”ê°€

**ì •ìƒ íë¦„**: ì„¸ì…˜ì´ ì‚­ì œëœ í›„ `/api/auth/check`ê°€ í˜¸ì¶œë˜ë©´
- ì¿ í‚¤ì—ì„œ í† í°ì„ ì½ìœ¼ë ¤ í•¨
- ì¿ í‚¤ê°€ ì´ë¯¸ ì‚­ì œë¨ (UserController.logoutì—ì„œ ì‚­ì œ)
- `token == null` â†’ 401 ë°˜í™˜ (ì •ìƒ)

**ë¬¸ì œ íë¦„**: `/api/user/logout`ì´ ì™„ë£Œë˜ê¸° **ì „ì—** `/api/auth/check`ê°€ í˜¸ì¶œë˜ë©´
- ì¿ í‚¤ì— í† í°ì´ ì•„ì§ ì¡´ì¬í•¨
- í† í°ì´ ìœ íš¨í•¨ (ì„œëª… ê²€ì¦ í†µê³¼)
- sessionId = 993 ì¶”ì¶œ
- DBì—ì„œ ì„¸ì…˜ ì¡°íšŒ â†’ **ì´ë¯¸ ì‚­ì œë¨!**
- 401 ë°˜í™˜ + "ì°¨ë‹¨ë¨: DBì— ì—†ëŠ” ì„¸ì…˜ì…ë‹ˆë‹¤"

### 3.3 ì™œ `/api/auth/check`ê°€ ë‘ ë²ˆ í˜¸ì¶œë˜ëŠ”ê°€

```mermaid
flowchart LR
    subgraph "AuthProvider useEffect"
        E1["useEffect location.pathname ë³€ê²½<br/>â†’ checkAuthStatus()"]
    end
    
    subgraph "WebSocketProvider handleLogout"
        W1["window.addEventListener<br/>('authLogout')"]
    end
    
    E1 -->|"navigate('/')"| E1
    W1 -->|"handleLogout() í˜¸ì¶œ"| W1
    
    Note: ë‘ ê³³ì—ì„œ ëª¨ë‘ checkAuthStatus() ë˜ëŠ” isAuthenticated() í˜¸ì¶œ
```

1. **AuthProvider** (location.pathname ë³€ê²½):
   ```typescript
   // AuthProvider.tsx (line 128-148)
   useEffect(() => {
       if (authState.loading) return;
       // ...
       checkAuthStatus().then((result) => {
           // ...
       });
   }, [location.pathname, authState.loading, navigate]);
   ```

2. **WebSocketProvider** (authLogout ì´ë²¤íŠ¸):
   ```typescript
   // WebSocketProvider.tsx (line 131-143)
   const handleLogout = () => {
       isLoggedOutRef.current = true;
       // ...
   };
   ```

### 3.4 isLoggingOut í”Œë˜ê·¸ì˜ ë¬¸ì œ

í˜„ì¬ `axiosConfig.ts`ì˜ `isLoggingOut` í”Œë˜ê·¸:

```typescript
// axiosConfig.ts
let isLoggingOut = false;

const handleAuthError = async (errorConfig, onAuthFailed, onAuthRestored) => {
    // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€
    if (isLoggingOut) {
        return false;
    }
    // ...
};
```

**ë¬¸ì œ**: ì´ í”Œë˜ê·¸ëŠ” **axios interceptor ì•ˆì—ì„œë§Œ** í™•ì¸ë©ë‹ˆë‹¤.

í•˜ì§€ë§Œ `/api/auth/check`ì˜ 401 ì—ëŸ¬ëŠ”:
1. interceptorë¥¼ í†µê³¼í•¨ (200ì´ ì•„ë‹˜)
2. interceptorì˜ error handlerì—ì„œ ì²˜ë¦¬ë¨
3. `isLoggingOut`ì´ `true`ì¸ì§€ í™•ì¸ë¨

â†’ **`isLoggingOut`ì´ `true`ì—¬ì„œ ì¤‘ë³µ ì²˜ë¦¬ê°€ ë°©ì§€ë˜ì–´ì•¼ í•˜ëŠ”ë°...**

ë¬¸ì œëŠ” `/api/auth/check` ì—ëŸ¬ê°€ **handleAuthErrorë¡œ ì „ë‹¬ë˜ê¸° ì „ì—** `isLoggingOut`ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## 4. í•´ê²° ë°©ì•ˆ

### 4.1 ê¶Œì¥ í•´ê²°ì±…: AuthUtilityì— isLoggingOut í”Œë˜ê·¸ ì¶”ê°€

```typescript
// authUtility.ts

let authCheckPromise: Promise<...> | null = null;
let authCheckResult: { authenticated: boolean; ... } | null = null;
let isLoggingOut = false;  // âœ… ì¶”ê°€: ë¡œê·¸ì•„ì›ƒ ì¤‘ í”Œë˜ê·¸

export const checkAuthStatus = async (): Promise<...> => {
    // âœ… ë¡œê·¸ì•„ì›ƒ ì¤‘ì´ë©´ ì¦‰ì‹œ false ë°˜í™˜ (API í˜¸ì¶œ ì•ˆ í•¨)
    if (isLoggingOut) {
        return { authenticated: false };
    }
    
    if (authCheckResult !== null) {
        return authCheckResult;
    }
    
    if (authCheckPromise !== null) {
        return authCheckPromise;
    }
    
    authCheckPromise = axios.get('/api/auth/check')
        .then(response => {
            const result = {
                authenticated: true,
                user: response.data.user
            };
            authCheckResult = result;
            return result;
        })
        .catch(error => {
            if (error.response?.status === 401) {
                authCheckResult = { authenticated: false };
                return authCheckResult;
            }
            authCheckResult = { authenticated: false };
            return authCheckResult;
        })
        .finally(() => {
            authCheckPromise = null;
        });
    
    return authCheckPromise;
};

// ë¡œê·¸ì•„ì›ƒ ì‹œ í˜¸ì¶œ
export const setLoggingOut = () => {
    isLoggingOut = true;
    // 1ì´ˆ í›„ ìë™ ë¦¬ì…‹ (timeout ì•ˆì „ì¥ì¹˜)
    setTimeout(() => {
        isLoggingOut = false;
    }, 1000);
};
```

### 4.2 AuthProviderì—ì„œ logout ì‹œ í”Œë˜ê·¸ ì„¤ì •

```typescript
// AuthProvider.tsx

const logout = useCallback(async (reason?: string) => {
    // âœ… ë¡œê·¸ì•„ì›ƒ ì‹œì‘ í‘œì‹œ (checkAuthStatusì—ì„œ API í˜¸ì¶œ ë°©ì§€)
    setLoggingOut();  // isLoggingOut = true
    
    // í† ìŠ¤íŠ¸ í‘œì‹œ
    if (reason) {
        showToast(reason, 'error');
    }

    // ë¡œì»¬ ìƒíƒœ ì •ë¦¬
    setAuthState({
        authenticated: false,
        user: null,
        loading: false,
    });

    // ì¸ì¦ í™•ì¸ ê²°ê³¼ ë¦¬ì…‹
    resetAuthCheck();

    // ì„œë²„ ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ
    try {
        await userApi.logout(undefined);
    } catch (e) {
        devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ API ì˜¤ë¥˜:', e);
    }

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    navigate('/', { replace: true });

    devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
}, [navigate]);
```

### 4.3 ëŒ€ì•ˆ: useEffectì—ì„œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€

```typescript
// AuthProvider.tsx

// ë¡œê·¸ì•„ì›ƒ ì¤‘ì¸ì§€ ì¶”ì í•˜ëŠ” ref
const isLoggingOutRef = useRef(false);

useEffect(() => {
    let mounted = true;
    
    // Axios interceptor ì„¤ì •
    setupAxiosInterceptors({
        onAuthFailed: (message: string) => {
            // âœ… ë¡œê·¸ì•„ì›ƒ ì¤‘ì´ë©´ handleLogout í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
            if (isLoggingOutRef.current) {
                return;
            }
            handleLogout(message);
        },
        onAuthRestored: () => {
            forceReconnect();
        },
    });
    
    // ...
    
    checkAuthStatus().then((result) => {
        if (mounted) {
            // ...
        }
    });
    
    return () => {
        mounted = false;
    };
}, [handleLogout, forceReconnect, location.pathname]);

// logout í•¨ìˆ˜ì—ì„œ ref ì„¤ì •
const logout = useCallback(async (reason?: string) => {
    isLoggingOutRef.current = true;  // âœ… ë¡œê·¸ì•„ì›ƒ ì¤‘ í‘œì‹œ
    
    // ... ê¸°ì¡´ ë¡œì§ ...
    
    navigate('/', { replace: true });
    
    // navigate í›„ ì•½ê°„ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë¦¬ì…‹
    setTimeout(() => {
        isLoggingOutRef.current = false;
    }, 100);
    
    devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
}, [navigate]);
```

### 4.4 ë” ê°„ë‹¨í•œ í•´ê²°ì±…: checkAuthStatus í˜¸ì¶œ ì§€ì—°

```typescript
// logout í•¨ìˆ˜ì—ì„œ navigate ì „ì— ì•½ê°„ ê¸°ë‹¤ë¦¼

const logout = useCallback(async (reason?: string) => {
    // ... ê¸°ì¡´ ë¡œì§ ...
    
    // ì„œë²„ ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ
    try {
        await userApi.logout(undefined);
    } catch (e) {
        devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ API ì˜¤ë¥˜:', e);
    }

    // âœ… ì¿ í‚¤ê°€ ì‚­ì œë  ë•Œê¹Œì§€ ì•½ê°„ ê¸°ë‹¤ë¦¼
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // ì¸ì¦ í™•ì¸ ê²°ê³¼ ë¦¬ì…‹ (ì´ì œ ì•ˆì „í•¨)
    resetAuthCheck();

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    navigate('/', { replace: true });

    devLog('[AuthProvider] ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
}, [navigate]);
```

## 5. ìµœì¢… ê¶Œì¥ ì‚¬í•­

### 5.1 ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ í•´ê²°ì±… (ê°€ì¥ ê°„ë‹¨)

**`authUtility.ts`ì— `isLoggingOut` í”Œë˜ê·¸ ì¶”ê°€**:

```typescript
let isLoggingOut = false;

export const checkAuthStatus = async (): Promise<...> => {
    if (isLoggingOut) {
        return { authenticated: false };
    }
    // ... ê¸°ì¡´ ë¡œì§ ...
};

export const setLoggingOut = () => {
    isLoggingOut = true;
    setTimeout(() => {
        isLoggingOut = false;
    }, 1000);
};
```

**`AuthProvider.tsx`ì˜ `logout` í•¨ìˆ˜ì—ì„œ í˜¸ì¶œ**:

```typescript
const logout = useCallback(async (reason?: string) => {
    setLoggingOut();  // âœ… ì¶”ê°€
    
    // ... ê¸°ì¡´ ë¡œì§ ...
}, [navigate]);
```

### 5.2 ì˜ˆìƒ íš¨ê³¼

| ë¬¸ì œ | í•´ê²° ì—¬ë¶€ |
|------|----------|
| "ì°¨ë‹¨ë¨: DBì— ì—†ëŠ” ì„¸ì…˜ì…ë‹ˆë‹¤" ì—ëŸ¬ | âœ… í•´ê²° |
| ì¤‘ë³µ ë¡œê·¸ì•„ì›ƒ | âœ… í•´ê²° |
| race condition | âœ… í•´ê²° |

### 5.3 ì¶”ê°€ ê²€í†  ì‚¬í•­

1. **JwtAuthenticationFilterì—ì„œ `/api/auth/check` ì œì™¸ ì—¬ë¶€**
   - í˜„ì¬ `/api/auth/check`ëŠ” JwtFilterë¥¼ ê±°ì¹¨
   - `/api/auth/check`ì—ì„œ JwtFilterë¥¼ ì œì™¸í•˜ë©´ ë” ê°„ë‹¨í•´ì§
   - í•˜ì§€ë§Œ `/api/auth/check` ìì²´ê°€ ì¸ì¦ í™•ì¸ ë¡œì§ì„ í¬í•¨í•˜ë¯€ë¡œ ì£¼ì˜ í•„ìš”

2. **ì¿ í‚¤ ì‚­ì œ íƒ€ì´ë°**
   - í˜„ì¬: UserController.logoutì—ì„œ ì„¸ì…˜ ì‚­ì œ í›„ ì¿ í‚¤ ì‚­ì œ
   - ê°œì„ : ì¿ í‚¤ë¥¼ ë¨¼ì € ì‚­ì œí•˜ê³  ì„¸ì…˜ì„ ì‚­ì œí•˜ë©´ race condition ê°ì†Œ
