í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì¸ì¦/ë³´ì•ˆ ê´€ë ¨ ì½”ë“œë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤. ë°œê²¬ëœ ë¬¸ì œì ê³¼ ê°œì„  ê³„íšì„ ìƒì„¸íˆ ì •ë¦¬í•˜ê² ìŠµë‹ˆë‹¤.

## ğŸ” í˜„ì¬ ì•„í‚¤í…ì²˜ ë¶„ì„ ê²°ê³¼

### 1. í˜„ì¬ ì¸ì¦ íë¦„ë„

```mermaid
flowchart TD
    A[ì‚¬ìš©ì ë¡œê·¸ì¸] --> B[Login.tsx - setToken í˜¸ì¶œ]
    B --> C[localStorage - accessToken ì €ì¥]
    C --> D[localStorage - myId ì €ì¥]
    D --> E[ì¿ í‚¤ - HttpOnly Refresh Token]
    
    E --> F[API ìš”ì²­]
    F --> G{shouldRefreshToken?}
    G -->|ì˜ˆ| H[axiosConfig - refreshToken í˜¸ì¶œ]
    G -->|ì•„ë‹ˆì˜¤| I[ê¸°ì¡´ í† í° ì‚¬ìš©]
    H --> J[POST /api/sessions/refresh]
    J --> K[ìƒˆ Access Token ìˆ˜ì‹ ]
    K --> L[localStorage ì—…ë°ì´íŠ¸]
    
    M[WebSocket ì—°ê²°] --> N[ws://host/ws?token=...]
    N --> O{1006 ì—ëŸ¬?}
    O -->|ì˜ˆ| P[refreshToken ì¬í˜¸ì¶œ]
    P --> Q[ì¬ì—°ê²° ì‹œë„]
```

---

## âš ï¸ ë°œê²¬ëœ ë¬¸ì œì 

### ì‹¬ê°ë„: ğŸ”´ ë†’ìŒ

#### 1. **í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ ìš´ì˜ í™˜ê²½ì—ì„œ í™œì„±í™”ë¨**
```typescript
// src/utils/authUtility.ts:13
const IS_TEST_MODE = true; // í…ŒìŠ¤íŠ¸ ëª¨ë“œ: true = 10ì´ˆ, false = 30ë¶„
```
- **ë¬¸ì œ**: 10ì´ˆë§ˆë‹¤ í† í°ì´ ë§Œë£Œë˜ì–´ ì‹¤ì œ ìš´ì˜ì—ì„œ ì‹¬ê°í•œ ë¬¸ì œ ë°œìƒ
- **ì˜í–¥**: ì‚¬ìš©ì ê²½í—˜ ì €í•˜, ë¶ˆí•„ìš”í•œ API í˜¸ì¶œ ì¦ê°€

#### 2. **localStorageì— Access Token ì €ì¥ (XSS ì·¨ì•½ì )**
```typescript
// src/utils/authUtility.ts:219
localStorage.setItem('accessToken', token);
```
- **ë¬¸ì œ**: XSS ê³µê²© ì‹œ í† í° íƒˆì·¨ ìœ„í—˜
- **ëŒ€ì•ˆ**: HttpOnly ì¿ í‚¤ ì‚¬ìš© ë˜ëŠ” ë©”ëª¨ë¦¬ ì €ì¥ + Worker í™œìš©

#### 3. **Refresh Token ì¿ í‚¤ SameSite ë¶ˆì¼ì¹˜**
```typescript
// src/utils/authUtility.ts:161
document.cookie = 'refreshToken=; ... SameSite=Lax';
```
- **ë¬¸ì œ**: ì¿ í‚¤ ìƒì„± ì‹œ `SameSite=None` ì‚¬ìš©, ì‚­ì œ ì‹œ `SameSite=Lax` ì‚¬ìš© ë¶ˆì¼ì¹˜

### ì‹¬ê°ë„: ğŸŸ¡ ì¤‘ê°„

#### 4. **ì½”ë“œ ì¤‘ë³µ ë¬¸ì œ**

| ìœ„ì¹˜ | ì¤‘ë³µ ë‚´ìš© |
|------|----------|
| [`authUtility.ts:78`](src/utils/authUtility.ts:78) | `shouldRefreshToken()` í•¨ìˆ˜ |
| [`AuthProvider.tsx:50`](src/contexts/AuthProvider.tsx:50) | ë™ì¼í•œ ë¡œì§ ì¤‘ë³µ êµ¬í˜„ |
| [`authUtility.ts:91`](src/utils/authUtility.ts:91) | `isTokenValid()` í•¨ìˆ˜ |
| [`AuthProvider.tsx:23`](src/contexts/AuthProvider.tsx:23) | `checkTokenValid()` ì¤‘ë³µ |

#### 5. **ì¸ì¦ ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ**
```typescript
// AuthProvider.tsx:14-16
const [accessToken, setAccessToken] = useState<string | null>(() => {
  return localStorage.getItem('accessToken');
});
```
- **ë¬¸ì œ**: React Stateì™€ localStorage ê°„ ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±
- **ì˜í–¥**: AuthContextì˜ `isAuthenticated`ê°€ ì‹¤ì œ ìƒíƒœì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ

#### 6. **ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ íŒŒí¸í™”**

| íŒŒì¼ | ì—ëŸ¬ ì²˜ë¦¬ ë‚´ìš© |
|------|---------------|
| [`axiosConfig.ts`](src/utils/axiosConfig.ts:69) | 401, 403, 404 ì²˜ë¦¬ |
| [`WebSocketProvider.tsx`](src/contexts/WebSocketProvider.tsx:80) | 1006 ì—ëŸ¬ ì²˜ë¦¬ |
| [`App.tsx`](src/App.tsx:21) | FORCE_LOGOUT ì´ë²¤íŠ¸ ì²˜ë¦¬ |

#### 7. **ì¬ì—°ê²° ë¡œì§ ë¯¸í¡**
```typescript
// WebSocketProvider.tsx:109
reconnectTimerRef.current = window.setTimeout(() => {
  connectSocketRef.current?.();
}, 3000);
```
- **ë¬¸ì œ**: ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ ì—†ìŒ, ì§€ìˆ˜ ë°±ì˜¤í”„ ë¯¸êµ¬í˜„

### ì‹¬ê°ë„: ğŸŸ¢ ë‚®ìŒ (ê°œì„  ê¶Œì¥)

#### 8. **í† í° íƒˆì·¨ ê°ì§€ ë¯¸êµ¬í˜„**
- ë¹„ì •ìƒì  ìœ„ì¹˜/ê¸°ê¸°ì—ì„œì˜ ë¡œê·¸ì¸ ê°ì§€ ë¡œì§ ë¶€ì¬

#### 9. **Refresh Token Rotation ë¯¸êµ¬í˜„**
- Refresh Token ì‚¬ìš© ì‹œë§ˆë‹¤ ìƒˆë¡œìš´ Refresh Token ë°œê¸‰ ë¯¸ì‹¤í–‰

#### 10. **CSRF ë³´í˜¸ ë¯¸êµ¬í˜„**
- ì•ì„œ ë…¼ì˜í•œ CSRF í† í° ê²€ì¦ ë¡œì§ ë¯¸êµ¬í˜„

---

## ğŸ“‹ ê°œì„  ìš°ì„ ìˆœìœ„ ë° ê³„íš

### Phase 1: ê¸´ê¸‰ ìˆ˜ì • (ì¦‰ì‹œ ì ìš© í•„ìš”)

```mermaid
flowchart LR
    subgraph "Phase 1: ê¸´ê¸‰"
        A[IS_TEST_MODE falseë¡œ ë³€ê²½] --> B[ì¿ í‚¤ SameSite í†µì¼]
        B --> C[React State ë™ê¸°í™” ê°œì„ ]
    end
```

| ìˆœì„œ | ì‘ì—… ë‚´ìš© | íŒŒì¼ |
|------|----------|------|
| 1 | `IS_TEST_MODE = false` ë³€ê²½ | [`authUtility.ts:13`](src/utils/authUtility.ts:13) |
| 2 | ì¿ í‚¤ SameSite ì†ì„± í†µì¼ (`SameSite=None`) | [`authUtility.ts:161-163`](src/utils/authUtility.ts:161) |
| 3 | AuthProviderì™€ authUtility ê°„ ë¡œì§ í†µí•© | [`AuthProvider.tsx`](src/contexts/AuthProvider.tsx) |

### Phase 2: ë³´ì•ˆ ê°•í™”

| ìˆœì„œ | ì‘ì—… ë‚´ìš© | ì„¤ëª… |
|------|----------|------|
| 1 | Access Tokenì„ HttpOnly ì¿ í‚¤ë¡œ ì „í™˜ | XSS ë°©ì§€ |
| 2 | Refresh Token Rotation êµ¬í˜„ | ë³´ì•ˆ í–¥ìƒ |
| 3 | CSRF í† í° ê²€ì¦ ì¶”ê°€ | í¬ë¡œìŠ¤ì‚¬ì´íŠ¸ ìš”ì²­ ìœ„ì¡° ë°©ì§€ |

### Phase 3: ì½”ë“œ ë¦¬íŒ©í† ë§ ë° ëª¨ë“ˆí™”

```mermaid
flowchart TD
    subgraph "í˜„ì¬ êµ¬ì¡°"
        A[authUtility.ts] --> B[authCore.ts]
        A --> C[axiosConfig.ts]
        A --> D[AuthProvider.tsx]
        A --> E[WebSocketProvider.tsx]
    end
    
    subgraph "ëª¨ë“ˆí™” í›„ êµ¬ì¡°"
        F[@spring-core/auth-core] --> G[@spring-core/axios-interceptor]
        F --> H[@spring-core/react-auth]
        F --> I[@spring-core/websocket]
    end
```

---

## ğŸ¯ ëª¨ë“ˆí™”ëœ ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ê³„

### ê¶Œì¥ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
src/
â”œâ”€â”€ auth/                          # ìƒˆë¡œìš´ ì¸ì¦ ëª¨ë“ˆ ë””ë ‰í† ë¦¬
â”‚   â”œâ”€â”€ core/                      # í•µì‹¬ ì¸ì¦ ë¡œì§
â”‚   â”‚   â”œâ”€â”€ index.ts              # exports
â”‚   â”‚   â”œâ”€â”€ tokenManager.ts       # í† í° ê´€ë¦¬ (CRUD)
â”‚   â”‚   â”œâ”€â”€ tokenRefresh.ts       # í† í° ê°±ì‹  ë¡œì§
â”‚   â”‚   â”œâ”€â”€ tokenValidator.ts     # í† í° ê²€ì¦
â”‚   â”‚   â””â”€â”€ types.ts              # íƒ€ì… ì •ì˜
â”‚   â”‚
â”‚   â”œâ”€â”€ axios/                     # Axios ê´€ë ¨
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ interceptor.ts        # ìš”ì²­/ì‘ë‹µ ì¸í„°ì…‰í„°
â”‚   â”‚   â””â”€â”€ errorHandler.ts       # ì—ëŸ¬ ì²˜ë¦¬
â”‚   â”‚
â”‚   â”œâ”€â”€ react/                    # React ê´€ë ¨
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ AuthProvider.tsx      # Context Provider
â”‚   â”‚   â”œâ”€â”€ useAuth.ts            # useAuth hook
â”‚   â”‚   â”œâ”€â”€ useToken.ts           # useToken hook
â”‚   â”‚   â””â”€â”€ ProtectedRoute.tsx    # Protected Route
â”‚   â”‚
â”‚   â””â”€â”€ websocket/                 # WebSocket ê´€ë ¨
â”‚       â”œâ”€â”€ index.ts
â”‚       â”œâ”€â”€ WebSocketProvider.tsx
â”‚       â””â”€â”€ reconnectManager.ts   # ì¬ì—°ê²° ê´€ë¦¬
```

### í•µì‹¬ ì¸í„°í˜ì´ìŠ¤ ì„¤ê³„

```typescript
// auth/core/types.ts
export interface TokenManagerConfig {
  accessTokenKey: string;
  refreshTokenCookieName: string;
  expiresAtKey: string;
  accessTokenExpiresInSeconds: number;
  proactiveRefreshThresholdSeconds: number;
}

export interface AuthState {
  accessToken: string | null;
  refreshToken: string | null;
  expiresAt: number | null;
  isAuthenticated: boolean;
}

export interface TokenRefreshResult {
  success: boolean;
  newAccessToken?: string;
  error?: string;
}

// auth/core/tokenManager.ts
export class TokenManager {
  private config: TokenManagerConfig;
  
  constructor(config: TokenManagerConfig) {
    this.config = config;
  }
  
  // ë‹¨ì¼ ì±…ì„ ì›ì¹™: í† í° ì €ì¥ë§Œ ë‹´ë‹¹
  setAccessToken(token: string, expiresInSeconds: number): void {
    const expiresAt = Date.now() + (expiresInSeconds * 1000);
    localStorage.setItem(this.config.accessTokenKey, token);
    localStorage.setItem(this.config.expiresAtKey, expiresAt.toString());
  }
  
  getAccessToken(): string | null {
    return localStorage.getItem(this.config.accessTokenKey);
  }
  
  shouldRefresh(): boolean {
    const expiresAt = this.getExpiresAt();
    if (!expiresAt) return false;
    
    const threshold = this.config.proactiveRefreshThresholdSeconds * 1000;
    return Date.now() >= (expiresAt - threshold);
  }
}
```

---

## ğŸ“ í–¥í›„ ì‘ì—… ê³„íš

### ì¦‰ì‹œ ì ìš©í•  ê²ƒ (ì˜¤ëŠ˜)

1. **í…ŒìŠ¤íŠ¸ ëª¨ë“œ ë¹„í™œì„±í™”**
   ```typescript
   // authUtility.ts
   const IS_TEST_MODE = false; // ìš´ì˜ ëª¨ë“œ
   ```

2. **ì¿ í‚¤ SameSite í†µì¼**
   ```typescript
   // ëª¨ë“  ì¿ í‚¤ ì‘ì—…ì— SameSite=None; secure ì¶”ê°€
   document.cookie = `refreshToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=None; secure`;
   ```

### 1ì£¼ ì´ë‚´

3. **ì½”ë“œ ì¤‘ë³µ ì œê±°**
   - `shouldRefreshToken()` ë¡œì§ì„ authUtilityë¡œ í†µí•©
   - AuthProviderì—ì„œ authUtility í•¨ìˆ˜ ì¬ì‚¬ìš©

4. **ì¬ì—°ê²° ë¡œì§ ê°œì„ **
   - ì¬ì‹œë„ íšŸìˆ˜ ì œí•œ (ìµœëŒ€ 5íšŒ)
   - ì§€ìˆ˜ ë°±ì˜¤í”„ ì ìš©

### 1ê°œì›” ì´ë‚´

5. **ë³´ì•ˆ ê°•í™”**
   - Access Token HttpOnly ì¿ í‚¤ ì „í™˜ ê²€í† 
   - Refresh Token Rotation êµ¬í˜„
   - CSRF ë³´í˜¸ ì¶”ê°€

6. **ëª¨ë“ˆí™”**
   - auth ë””ë ‰í† ë¦¬ ìƒì„± ë° ì½”ë“œ ë¶„ë¦¬
   - npm íŒ¨í‚¤ì§€í™” ì¤€ë¹„

---

## â“ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­

1. **ë°±ì—”ë“œ ì¿ í‚¤ ì„¤ì • í™•ì¸**: `SameSite=None`ê³¼ `Secure` ì†ì„±ì´ ë°±ì—”ë“œì—ì„œë„ ë™ì¼í•˜ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.

2. **Refresh Token Rotation ì ìš© ì—¬ë¶€**: ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•´ Refresh Token ì‚¬ìš© ì‹œë§ˆë‹¤ ìƒˆë¡œìš´ Refresh Tokenì„ ë°œê¸‰í•˜ëŠ” ë¡œì§ì„ ë°±ì—”ë“œì— ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

3. **CSRF ë³´í˜¸ ë°©ì‹**: ì•ì„œ ë…¼ì˜í•œ ëŒ€ë¡œ Double Submit Cookie ë°©ì‹ì´ë‚˜ ê¸°ì¡´ Spring Security CSRF ë³´í˜¸ë¥¼ í™œìš©í• ì§€ ê²°ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

CRF(CSRF)ì™€ ê´€ë ¨í•´ì„œ, í˜„ì¬ ìƒíƒœì—ì„œ **Double Submit Cookie** ë°©ì‹ì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤. ì´ëŠ”:
- êµ¬í˜„ì´ ë‹¨ìˆœí•¨
- ê¸°ì¡´ Spring Security CSRFì™€ í˜¸í™˜ ê°€ëŠ¥
- Refresh Token ì¿ í‚¤ì— ì¶”ê°€ ê²€ì¦ ì ìš© ê°€ëŠ¥

ì´ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ í™•ì¸í•˜ê³  ì‹¶ì€ ì‚¬í•­ì´ë‚˜ ì¶”ê°€ ê²€í† ê°€ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìœ¼ì‹ ê°€ìš”?
