# 🛡️ 멀티 탭 중복 로그인 방어 전략 분석 (Full-Stack)

## 1. 문제 개요
동일한 브라우저의 여러 탭에서 로그인 페이지를 띄워놓은 경우, 한 탭에서의 로그인 성공이 다른 탭에 즉시 반영되지 않아 발생하는 세션 충돌(Session Conflict) 및 데이터 오염 문제를 해결하기 위한 전략입니다.

---

## 2. 발생 가능한 시나리오
1.  **동시 로그인 시도**: 브라우저 A 탭과 B 탭에서 각각 다른 아이디(또는 동일 아이디)로 거의 동시에 로그인을 시도하는 경우.
2.  **방치된 로그인 탭**: A 탭에서 로그인을 완료한 후, 이미 로그인 페이지가 열려있던 B 탭에서 다시 로그인을 시도하는 경우.
3.  **로그아웃 후 즉시 로그인**: 한 탭에서 로그아웃한 직후, 다른 탭에 남아있던 로그인 페이지를 통해 재로그인을 시도하는 경우.
4.  **비정상적인 세션 증식**: 악의적인 사용자가 매크로 등을 통해 짧은 시간 내 수많은 로그인 요청을 보내 세션 한도를 초과시키려는 시도.

---

## 3. 산업 표준 대응 방식
1.  **Session Pinning / Sticky Session**: 클라이언트 세션을 특정 유저 정보와 강하게 결합하여 혼선을 방지.
2.  **Single Sign-On (SSO) Flow**: 중앙 집중식 인증 처리를 통해 여러 탭/서비스 간의 상태를 단일화.
3.  **Token-based Invalidation**: 새로운 세션 생성 시 이전 세션을 즉시 무효화(Revoke)하거나, 세션 수를 제한.
4.  **Client-side Event Bus**: 브라우저의 `StorageEvent`나 `BroadcastChannel API`를 사용하여 탭 간 상태를 실시간 동기화.

---

## 4. 우리 프로젝트 적용 방안 (Layered Defense)

### 4.1 프론트엔드 (UX & 선제적 방어)
1.  **BroadcastChannel API (실시간 동기화)**
    - 한 탭에서 로그인/로그아웃 성공 시 `authSyncChannel`을 통해 `LOGIN_SYNC` 또는 `LOGOUT_SYNC` 메시지 전파.
    - 메시지를 수신한 다른 탭은 `checkAuthStatus(true)`를 통해 인증 상태를 동기화하고, 필요시 `/dashboard`로 리다이렉트하거나 로그아웃 처리.
2.  **로그인 전 상태 사전 체크 (Double-Lock)**
    - 실제 로그인 API를 호출하기 전 `checkAuthStatus(true)`를 실행하여 이미 유효한 쿠키 세션이 존재하는지 확인.
    - 이미 인증된 상태라면 로그인을 진행하지 않고 즉시 대시보드로 이동.
3.  **Ref와 State를 결합한 동기적 상태 추적**
    - `isAuthenticatedRef`를 사용하여 React의 비동기적 State 업데이트로 인한 '찰나의 인증 공백' 방지.

### 4.2 백엔드 (보안 및 최종 방어)
1.  **로그인 API 멱등성 및 충돌 처리**
    - `/api/user/login` 요청 시 이미 유효한 세션이 감지되면 `409 Conflict`를 반환하거나 기존 정보를 갱신하여 응답.
    - 클라이언트는 409 응답 수신 시 이미 로그인된 것으로 간주하고 상태 동기화 후 대시보드로 진입.
2.  **세션 생성 원자성 확보**
    - 동일 계정에 대해 짧은 시간 내 여러 로그인 요청이 올 경우, DB 트랜잭션을 통해 세션 수 제한(최대 5개)을 엄격히 준수.
3.  **유령 쿠키(Ghost Cookie) 데드락 방지**
    - `JwtAuthenticationFilter`에서 만료되거나 세션 정보가 없는 쿠키를 감지할 경우, 응답 헤더에 `Set-Cookie`를 포함하여 브라우저의 잘못된 쿠키를 즉시 삭제(Clear).

---

## 5. 시나리오별 작동 메커니즘 (Scenario Analysis)

| 시나리오 | 프론트엔드 대응 | 백엔드 대응 | 결과 |
| :--- | :--- | :--- | :--- |
| **탭 1 로그인 후 탭 2 방치** | `LOGIN_SYNC` 수신 후 탭 2를 즉시 대시보드로 이동 | (개입 없음) | 최상의 UX 제공 |
| **탭 1, 2 거의 동시에 로그인 클릭** | Pre-check가 탭 2의 로그인을 일차적으로 차단 | 로그인 API 시작 시 쿠키 체크 및 `409 Conflict` 응답 | 데이터 무결성 보장 |
| **로그인 후 뒤로가기로 로그인창 진입** | `useEffect` 내 인증 체크로 대시보드 강제 복귀 | (개입 없음) | 비정상 접근 차단 |
| **유령 쿠키로 인한 무한 루프** | 401 에러 수신 후 로그아웃 프로세스 가동 | `JwtAuthenticationFilter`가 쿠키 삭제 명령 하달 | 데드락 자동 해결 |

---

## 6. 기대 효과
1.  **데이터 무결성**: 동일 브라우저 내에서 서로 다른 유저 정보가 뒤섞이는 현상을 원천 차단.
2.  **보안성 강화**: 세션 하이재킹 및 비정상적인 세션 증식을 방지하며, 좀비 세션(유령 쿠키)을 자동으로 정리.
3.  **사용자 경험**: 별도의 새로고침 없이도 모든 탭이 사용자의 최신 인증 상태를 스스로 추적하여 반응.
