# 시스템 아키텍처

## 1. 전체 아키텍처

```mermaid
flowchart TB
    subgraph Client [프론트엔드 - React]
        subgraph Contexts
            AP[AuthProvider]
            WP[WebSocketProvider]
            UP[UserLocationProvider]
        end
        
        subgraph Pages
            Login[로그인 페이지]
            Dashboard[대시보드]
            Device[기기 관리]
        end
        
        subgraph Utils
            AU[authUtility]
            AC[axiosConfig]
        end
    end
    
    subgraph Server [백엔드 - Spring Boot]
        subgraph Controllers
            UC[UserController]
            SC[SessionController]
            AC2[AuthController]
            WC[WeatherController]
            MC[MemoController]
        end
        
        subgraph Services
            US[UserService]
            SS[SessionService]
            WS[WeatherService]
        end
        
        subgraph Security
            JWT[JwtTokenProvider]
            SEC[SecurityConfig]
        end
        
        subgraph Handler
            WSH[WebSocketHandler]
        end
    end
    
    subgraph DB [H2 데이터베이스]
        Users[users 테이블]
        Sessions[user_sessions 테이블]
        Logs[access_log 테이블]
        Memos[memo 테이블]
        Chat[chat_log 테이블]
    end
    
    subgraph External [외부 API]
        OpenMeteo[OpenMeteo API]
    end
    
    Client --> |HTTP/REST| Server
    Client --> |WebSocket| WSH
    Server --> DB
    WS --> OpenMeteo
```

## 2. 인증 아키텍처

### 2.1 JWT 토큰 흐름

```mermaid
sequenceDiagram
    participant User as 사용자
    participant Frontend as 프론트엔드
    participant Backend as 백엔드
    participant DB as 데이터베이스
    
    User->>Frontend: 로그인 요청
    Frontend->>Backend: POST /api/user/login
    Backend->>DB: 자격 증명 검증
    DB-->>Backend: 사용자 데이터
    Backend->>Backend: JWT 토큰 생성
    Backend-->>Frontend: Set-Cookie: accessToken HttpOnly
    Frontend->>Frontend: 쿠키에 저장
    
    Note over Frontend,Backend: 이후 모든 요청
    
    Frontend->>Backend: 쿠키와 함께 요청
    Backend->>Backend: 쿠키에서 JWT 검증
    Backend-->>Frontend: 응답
```

### 2.2 토큰 저장 전략

| 저장소 | 타입 | 용도 |
|--------|------|------|
| HttpOnly 쿠키 | accessToken | 인증 토큰 |
| 메모리 (authUtility) | isLoggingIn/isLoggingOut | 상태 플래그 |
| React 상태 | authState | UI 상태 |

### 2.3 보안 기능

1. **HttpOnly 쿠키**: JavaScript에서 토큰 접근 불가 (XSS 방지)
2. **SameSite 쿠키**: CSRF 방지
3. **세션 기반 기기 관리**: 각 기기마다 고유 세션 ID
4. **토큰 만료**: 설정 가능 (테스트 15초 / 운영 30분)

## 3. 웹소켓 아키텍처

### 3.1 연결 흐름

```mermaid
sequenceDiagram
    participant Frontend as 프론트엔드
    participant JwtInterceptor as JWT 인터셉터
    participant WebSocketHandler as 웹소켓 핸들러
    participant SessionManager as 세션 관리자
    
    Frontend->>JwtInterceptor: 웹소켓 연결 요청
    JwtInterceptor->>JwtInterceptor: 쿠키에서 토큰 추출
    JwtInterceptor->>JwtInterceptor: 토큰 검증
    JwtInterceptor-->>WebSocketHandler: Principal 전달
    WebSocketHandler->>SessionManager: 세션 등록
    WebSocketHandler-->>Frontend: 연결 완료
    
    Note over Frontend,WebSocketHandler: 실시간 통신
    
    WebSocketHandler->>Frontend: NEW_DEVICE_LOGIN 이벤트
    WebSocketHandler->>Frontend: FORCE_LOGOUT 코드 4001
```

### 3.2 웹소켓 메시지 타입

| 타입 | 방향 | 설명 |
|------|------|------|
| NEW_DEVICE_LOGIN | 서버 -> 클라이언트 | 새 기기 로그인 알림 |
| FORCE_LOGOUT (4001) | 서버 -> 클라이언트 | 강제 연결 해제 알림 |
| CHAT | 클라이언트 -> 서버 | 채팅 메시지 전송 |
| CHAT | 서버 -> 클라이언트 | 채팅 메시지 브로드캐스트 |

## 4. 상태 관리 아키텍처

### 4.1 프론트엔드 상태 계층

```mermaid
flowchart TB
    subgraph Global [전역 상태]
        ACX[AuthContext]
        WCX[WebSocketContext]
        UCX[UserLocationContext]
    end
    
    subgraph Server [서버 상태 - React Query]
        Dashboard[대시보드 데이터]
        Weather[날씨 데이터]
        Sessions[세션 데이터]
    end
    
    subgraph Local [로컬 상태]
        WidgetState[위젯 위치]
        FormState[폼 입력]
    end
    
    Global --> Server
    Server --> Local
```

### 4.2 상태 동기화

| 상태 | 저장소 | 동기화 방식 |
|------|--------|-------------|
| 인증 | Context + 쿠키 | JWT 검증 |
| 웹소켓 | Context | 이벤트 기반 |
| 대시보드 데이터 | React Query | 자동 갱신 |
| 위젯 레이아웃 | localStorage | 수동 저장 |

## 5. 에러 처리 아키텍처

### 5.1 에러 흐름

```mermaid
flowchart TB
    subgraph Frontend [프론트엔드]
        A[Axios 인터셉터]
        B[authUtility]
        C[AuthProvider]
        D[ErrorBoundary]
    end
    
    subgraph Backend [백엔드]
        E[GlobalExceptionHandler]
        F[CustomException]
    end
    
    A --> |401/403| B
    B --> |인증 확인| C
    C --> |로그아웃| G[로그인 페이지]
    
    E --> |에러 응답| A
    F --> |비즈니스 에러| E
    
    D --> |React 에러| H[ErrorFallback]
```

### 5.2 에러 코드 매핑

| HTTP 상태 | 에러 코드 | 동작 |
|-----------|----------|------|
| 401 | - | 토큰 만료, 재인증 |
| 403 | A006 | 새 기기 로그인 (에러 아님) |
| 403 | 기타 | 접근 거부, 로그아웃 |
| 404 | - | 리소스 없음 |
| 500 | - | 서버 에러, 토스트 표시 |

## 6. 데이터 흐름 아키텍처

### 6.1 요청 흐름

```mermaid
flowchart LR
    A[사용자 액션] --> B[React 이벤트 핸들러]
    B --> C[API 함수]
    C --> D[Axios 요청]
    D --> E[Spring 컨트롤러]
    E --> F[서비스 계층]
    F --> G[MyBatis 매퍼]
    G --> H[H2 데이터베이스]
    
    H --> G
    G --> F
    F --> E
    E --> D
    D --> I[응답 핸들러]
    I --> J[상태 업데이트]
    J --> K[UI 리렌더링]
```

### 6.2 캐싱 전략

| 데이터 타입 | 캐시 방식 | TTL |
|-------------|----------|-----|
| 인증 상태 | 메모리 + TTL | 5초 |
| 날씨 데이터 | React Query | 5분 |
| 세션 목록 | React Query | 캐시 없음 |
| 위젯 레이아웃 | localStorage | 영구 |

## 7. 배포 아키텍처

### 7.1 개발 환경

```
프론트엔드 (Vite 개발 서버)  : http://localhost:5173
백엔드 (Spring Boot)         : http://localhost:8080
데이터베이스 (H2 콘솔)       : http://localhost:8080/h2-console
```

### 7.2 운영 환경 (권장)

```
프론트엔드 (정적 파일)        : Spring Boot에서 서빙
백엔드 (Spring Boot)         : 단일 인스턴스
데이터베이스 (H2 파일)       : 애플리케이션 내장
```

## 8. 보안 아키텍처

### 8.1 보안 계층

```mermaid
flowchart TB
    subgraph Layer1 [네트워크 계층]
        HTTPS[HTTPS/TLS]
        CORS[CORS 정책]
    end
    
    subgraph Layer2 [애플리케이션 계층]
        Cookie[HttpOnly 쿠키]
        SameSite[SameSite 속성]
    end
    
    subgraph Layer3 [인증 계층]
        JWT[JWT 검증]
        Session[세션 관리]
    end
    
    subgraph Layer4 [인가 계층]
        Role[역할 기반 접근]
        Owner[리소스 소유권]
    end
    
    Layer1 --> Layer2
    Layer2 --> Layer3
    Layer3 --> Layer4
```

### 8.2 보안 설정 요약

| 기능 | 설정 | 목적 |
|------|------|------|
| 쿠키 HttpOnly | true | XSS 방지 |
| 쿠키 Secure | 자동 (HTTPS) | MITM 방지 |
| 쿠키 SameSite | Lax | CSRF 방지 |
| JWT 만료 | 15초/30분 | 토큰 수명 |
| 기기별 세션 | true | 기기 추적 |
